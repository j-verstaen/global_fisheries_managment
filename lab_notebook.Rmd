---
title: "lab_notebook"
author: "Juliette Verstaen"
date: "November 2, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Loading packages
```{r}

suppressPackageStartupMessages({
  library(tidyverse)
  library(tidyr)
  library(here)
  library(ggplot2)
  library(dplyr)
  library(readxl)
  library(devtools)
  library(plotly)
  library(base)
  library(rio)
  library(plyr)
})


```

#converting projection csv into rds
no longer need the code because have already used it to create the files
```{r}

#Upside data
#projection_data_csv <- read_csv("data/ProjectionData.csv")

#saveRDS(projection_data_csv, "projection_data.rds")

#WDPA_Nov2018.csv <- read_csv("data/WDPA_Nov2018.csv")

#saveRDS(WDPA_Nov2018.csv, "WDPA_Nov2018.rds")

```



#Load Data
```{r}

#Corbet data: when countries began using RBFs
countries_ITQ <- read_excel("data/Countries_ITQ.xlsx")

#Upside data
projection_data <- readRDS("data/projection_data.rds")

#MPA data
MPA <- readRDS("data/WDPA_Nov2018.rds")

#RAMS
load("data/DBdata-model_fits_included.RData")

#number_species <- unique(stock$scientificname)
#341 different species

#cooperative data from "Conservation incentives and collective choices in cooperative fisheries" paper (Ovando et al 2013)
jc_coop <- read_csv("data/clean_cooperatives_data.csv")

#EDF turf data
edf_turf <- read_excel("data/EDF_TURF_data.xlsx")

```


Important/Necessary Data
tcbest.data #the best estimate of catch for that stock
tbbest.dat # the best estimate of biomass for that stock
divbpref # B/bmsy
divupref.data # u/umsy


Juliette Notes:

Handy functions for updating data frames:
match()
separate()

Useful Websites:
https://uc-r.github.io/tidyr

#RAM data wrangling
```{r}
ram <- timeseries_values_views %>%
  select("stocklong", "year", "TBbest", "TCbest", "BdivBmsypref", "UdivUmsypref") %>%
  add_column("RAM")

colnames(ram) <- c( "CommName", "Year", "Biomass", "Catch", "BvBmsy", "FvFmsy", "DBase")

#ram_2012 <- ram %>%
#  filter(Year > "2012") 
##this wont work because projection data has projected out past 2012. need to UPDATE

#updated 
#projection_ram <- bind_rows(list(projection_data, ram_2012))

2012-1950
#62
2050- 2012
#38
162+38

acheck <- filter(projection_ram, Year == "2013") %>%
  select("IdOrig", "CommName", "Year", "Biomass")

acheck_count <- unique(acheck$IdOrig)
acheck_count
#4714

yearcheck <- unique(projection_data$Year)
yearcheck
#101 years starts 1950 end 2050

join_project_ram <- join(projection_data, ram, by = c("CommName", "Year"), type = "full")

projectramcheck <- filter(join_project_ram, IdOrig == "NA")
#returns no rows with NA, could still be right if updated projected 

#Checking to see if better way to do join
# end up with WAY to many rows, something is off
#unite_projection_commname <- projection_data %>% 
#  unite(name_year, CommName, Year, sep = "-")
#unite_ram_commname <- ram %>% 
#  unite (name_year, CommName, Year, sep = "-")
#join_project_ram_2 <- join(unite_projection_commname, unite_projection_commname, by = "name_year", type = "left")

match_project_ram <- match(projection_data, ram)

```


#Data Wrangling: Projection and Countries ITQ
```{r}

#seperate out IdOrig column for Projection Data
separate_projection <- projection_ram %>% separate(IdOrig, c("agency", "stock", "t0", "tf", "data_enterer"))
    ###unsure what the last column actually is, double check

head(separate_projection, 10)

#reunite just the two parts we care about: agency and stock
unite_projection <- separate_projection %>% unite(assess_id_short, agency, stock, sep = "-")

#simplifying Countries ITQ with unique columns to prepare to merge
countries_ITQ_simple <- select(countries_ITQ, "assess_id_short", "year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")

#rename year to be capitalized to merge with projection data
colnames(countries_ITQ_simple) <- c("assess_id_short", "Year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")


ITQ_projection_merge <- merge(unite_projection, countries_ITQ_simple, by = c("assess_id_short", "Year"), all = TRUE)


#cleaning it up
ITQ_projection <- ITQ_projection_merge %>% unite(IdOrig, assess_id_short, t0, tf, data_enterer, sep = "-")

```

Playing with Data

#Total number of species with stocks
#Number of stocks with ITQs implemented
```{r}
IdOrig <- unique(ITQ_projection$SciName)
IdOrig
#1228 species total

ITQ_projection_implemented <- filter(ITQ_projection, programstart != "NA")

IdOrig_implemented <- unique(ITQ_projection_implemented$SciName)
IdOrig_implemented
#80 species with ITQ implemented
```


#Graphs for fun

ABARES_BGRDRSE
implemented ITQs in 1992
```{r}

ABARES_BGRDRSE <- filter(ITQ_projection, IdOrig == "ABARES-BGRDRSE-1960-2011-CHING")

graph_ABARES_BGRDRSE <-ggplot(ABARES_BGRDRSE, aes(x=Year, y=Biomass))+
  geom_line(size=1)+
  ggtitle("ABARES_BGRDRSE (Australia")+
  geom_point()+
  geom_line()+
  labs(x="Year", y="Yearly total biomass")+
  theme_classic()+
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  geom_vline(xintercept = 1992)+
  theme(legend.title=element_blank())

ggplotly(graph_ABARES_BGRDRSE)

#figure out an if then statement for line?


```


ADFG-HERRTOGE
never implemented ITQs
```{r}
ADFG_HERRTOGE <- filter(ITQ_projection, IdOrig == "ADFG-HERRTOG-1990-2010-HIVELY")

graph_ADFG_HERRTOGE <-ggplot(ADFG_HERRTOGE, aes(x=Year, y=Biomass))+
  geom_line(size=1)+
  ggtitle("ADFG-HERRTOGE (USA)")+
  geom_point()+
  geom_line()+
  labs(x="Year", y="Yearly total biomass")+
  theme_classic()+
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  theme(legend.title=element_blank())

ggplotly(graph_ADFG_HERRTOGE)

#figure out an if then statement for line?
```

Important/Necessary Data
tcbest.data #the best estimate of catch for that stock
tbbest.dat # the best estimate of biomass for that stock
divbpref # B/bmsy
divupref.data # u/umsy




Attempts at updating ITQ_projection with Rams
#asked ana about this -> waiting to hear back
```{r}

##this doesn't work; gives you vector not updated data frame
RAMS_ITQ_projection <- match(ITQ_projection_year$CommYear, ram_merge$CommYear)

#what happens when i just merge the two?
#test_merge <- merge(ITQ_projection_year, ram_merge, by = c("Name_Year"))


```


##edf turf data wrangling
# waiting for data from Gina if its more comprehensive than the EDF one
```{r}

edf_turf_unite <- edf_turf %>% unite(SciName, genus, species, sep = " ")


edf_turf_simple <- edf_turf_unite %>%
  add_column("turf") %>%
  select("country", "start_date", "SciName") %>%
  gsub('\\bNA NA\\b', 'NA')

colnames(edf_turf_simple) <- c("Country", "turfstart", "SciName")

##want to merge the edf simple with ITQ/Projections but maybe wait for Gina to respond with her TURF data
##in ITQ data says only one species of fish in japan has TURFs but not true

edf_projection_itq <- merge(ITQ_projection, edf_turf_simple, by = c("Country", "SciName"))
#only three species from the EDF data match with the species from the upside/projection data; all in Japan

```


Need to create new dataset (half upside half ITQ): Species, turf/itq, country,and then matching all the parameters with the species


################
################
###############
PART 2
1) pull the ITQ, IVQ, IQ fisheries out of upside.
2) pull the TURF fisheries from EDF.
3) For each fishery, we want species, location, and ITQ vs. TURF.

From updating_projection.R script file
```{r}

#Load Data
#Upside data
projection_data <- readRDS("data/projection_data.rds")

#RAMS
load("data/DBdata-model_fits_included.RData")

#Corbet data: when countries began using RBFs
countries_ITQ <- read_excel("data/Countries_ITQ.xlsx")



#RAM Data Tiddying
ram <- timeseries_values_views %>%
  select("stocklong", "year", "TBbest", "TCbest", "BdivBmsypref", "UdivUmsypref") %>%
  add_column("RAM")

colnames(ram) <- c( "CommName", "Year", "Biomass", "Catch", "BvBmsy", "FvFmsy", "DBase")


#Update Projection with RAM
projection_updated <- join(projection_data, ram, by = c("CommName", "Year"), type = "full")

#Merge Projection and ITQ
#seperate out IdOrig column for Projection Data
separate_projection <- projection_updated %>% separate(IdOrig, c("agency", "stock", "t0", "tf", "data_enterer"))

head(separate_projection, 10)

#reunite just the two parts we care about: agency and stock
unite_projection <- separate_projection %>% unite(assess_id_short, agency, stock, sep = "-")

#simplifying Countries ITQ with unique columns to prepare to merge
countries_ITQ_simple <- select(countries_ITQ, "assess_id_short", "year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")

#rename year to be capitalized to merge with projection data
colnames(countries_ITQ_simple) <- c("assess_id_short", "Year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")

ITQ_projection_merge <- merge(unite_projection, countries_ITQ_simple, by = c("assess_id_short", "Year"), all = TRUE)

#cleaning it up
ITQ_projection <- ITQ_projection_merge %>% unite(IdOrig, assess_id_short, t0, tf, data_enterer, sep = "-")

#create RDS from dataframe
#saveRDS(ITQ_projection, "ITQ_projection")


#simplified projection data
ITQ_projection_simple <- ITQ_projection %>%
  select("Country", "Year", "CommName", "SciName", "SpeciesCat", "CatchShare", "Catch", "Biomass", "BvBmsy", "FvFmsy","MSY", "Price", "g", "k", "c", "phi", "yearitq", "itq_now","iq", "itq", "ivq", "turf", "programstart")

#create RDS from dataframe
#saveRDS(ITQ_projection_simple, "projection_updated.rds")

#upside updated
upside_2018_updated <- ITQ_projection %>%
  select("Country", "Year", "CommName", "SciName", "SpeciesCat", "CatchShare", "Catch", "Biomass", "BvBmsy", "FvFmsy","MSY", "Price", "g", "k", "c", "phi")

#create RDS from dataframe
#saveRDS(upside_2018_updated, "upside_2018_updated")

```



#load data
```{r}

# create dataframe with 
ITQ_projection <- readRDS("processed_data/ITQ_projection.rds")

itq <- ITQ_projection %>%
  select("Country", "SciName", "itq_now","iq", "itq", "ivq", "turf", "programstart")

#Load EDF TURF data

edf_turf <- read_excel("data/EDF_TURF_data.xlsx")

#load in DiscoverTURFs data

d_turfs <- read_excel("data/DiscoverTURFs_simple.xlsx")

```


#data wrangling
```{r}


edf_turf_simple <- select(edf_turf, "country", "start_date", "SciName", "turf")
#create new column that says "turf" and TRUE or FALSE


colnames(edf_turf_simple) <- c("Country", "programstart", "SciName", "turf")

#combining edf turf data from upside data
edf_projection_1 <- join(edf_turf_simple, itq, by = c("Country", "programstart", "SciName", "turf"), type = "full")

#combine edf/upside with discover turfs
all_turf_1 <- join(edf_projection_1, d_turfs, by = c("Country", "SciName", "turf"), type = "full")

#change "blank" NAs to real NAs
#all_turf_1[is.na(all_turf_1)] <- "NA"

#rearrange columns
all_turf_itq <- all_turf_1[, c(1,3,2,5,6,7,8,4)]

#turning NAs from no ITQ data to FALSE
#all_turf_2[all_turf_2 == 0] <- NA

all_turf_itq$iq[is.na(all_turf_itq$iq)] <- FALSE

all_turf_itq$itq[is.na(all_turf_itq$itq)] <- FALSE

all_turf_itq$ivq[is.na(all_turf_itq$ivq)] <- FALSE

all_turf_itq$itq_now[is.na(all_turf_itq$itq_now)] <- 0

#create RDS from dataframe
#saveRDS(all_turf_itq, "all_turf_itq.rds")
#write.csv(all_turf_itq, file = "all_turf_itq.csv")


```

###################
##################

Part 3

1) include only species that are either TURF, ITQ, IVQ, etc. (omit species that are FALSE for everything).
2) Include each fishery only once (not multiple years).
3) so then see how hard it is to collect other characteristics for each species (like growth rate or ISCAAP category).

1 & 2
```{r}

#filter out all countries that don't have itqs or turfs
true_turf_itq_1 <- all_turf_itq %>%
  filter (iq == "TRUE" | itq == "TRUE" | ivq == "TRUE" | turf == "TRUE") %>%
  filter( Country != "NA") %>%
  select("Country", "SciName", "iq", "itq", "ivq", "turf") 
  

true_turf_itq <- unique(true_turf_itq_1 [ , 1:6])

unique(true_turf_itq$Country)
#33 countries
#Chile, Fiji, Italy, Japan, Mexico, Papua New Guinea, Samoa, Solomon Islands, Spain, Sri Lanka, Sweden, Vanuatu, Vietnam, Australia, USA, Canada, Peru, Argentina, South Africa, New Zealand, American Samoa, Belize, Brazil, Ecuador, France, Greece, India, Netherlands, Nigeria, Philippines, St Lucia, United States, United Kingdom  

#chile_itq_turf <- filter(true_turf_itq, Country == "Chile")
#unique(chile_itq_turf$SciName)
# 67

#fiji_itq_turf <- filter(only_turf_itq, Country == "Fiji")
#unique(fiji_itq_turf$SciName)

#test_duplicate <- unique(fiji_itq_turf[ , 1:8])


```


3
ISCAAP
```{r}

iscaap_cat_1 <- upside_2018_updated %>%
  select("SciName", "SpeciesCat") 

iscaap_cat <- unique(iscaap_cat_1 [ , 1:2])

true_turf_itq_iscaap_1 <- merge(true_turf_itq, iscaap_cat, by = "SciName", all = T)


true_turf_itq_iscaap <- true_turf_itq_iscaap_1 %>%
  filter( itq != "NA" & ivq != "NA" & iq != "NA" & turf != "NA") 

true_turf_itq_iscaap[is.na(true_turf_itq_iscaap)] <- "NA"

missing_speccat <- true_turf_itq_iscaap %>%
  filter(SpeciesCat == "NA")

write.csv(true_turf_itq_iscaap, file = "true_turf_itq_iscaap.csv")

determine_spec_cat <- as.vector(missing_speccat$SciName)
determine_spec_cat


```

FishBase

```{r}

library("rfishbase")

species <- as.vector(true_turf_itq_iscaap$SciName)
species

table_species <- species(species)

growth <- popgrowth(species)

#fishtest <- species_list(Genus = "Labroides")
#fishtest
#species(fishtest)
#even running the practice online tutorial get this error :Error in curl::curl_fetch_memory(url, handle = handle) : Timeout was reached: Connection timed out after 10004 milliseconds

#fishbase_test <- validate_names(species, fields = c("Species", ""))



```































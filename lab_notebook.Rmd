---
title: "lab_notebook"
author: "Juliette Verstaen"
date: "November 2, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Loading packages
```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(tidyr)
  library(here)
  library(ggplot2)
  library(dplyr)
  library(readxl)
  library(devtools)
  library(plotly)
  library(base)
  library(rio)
  library(plyr)
})


```

#converting projection csv into rds
no longer need the code because have already used it to create the files
```{r}

#Upside data
#projection_data_csv <- read_csv("data/ProjectionData.csv")

#saveRDS(projection_data_csv, "projection_data.rds")

#WDPA_Nov2018.csv <- read_csv("data/WDPA_Nov2018.csv")

#saveRDS(WDPA_Nov2018.csv, "WDPA_Nov2018.rds")

```



#Load Data
```{r}

#Corbet data: when countries began using RBFs
countries_ITQ <- read_excel("data/Countries_ITQ.xlsx")

#Upside data
projection_data <- readRDS("data/projection_data.rds")

#MPA data
MPA <- readRDS("data/WDPA_Nov2018.rds")

#RAMS
load("data/DBdata-model_fits_included.RData")

#number_species <- unique(stock$scientificname)
#341 different species

#cooperative data from "Conservation incentives and collective choices in cooperative fisheries" paper (Ovando et al 2013)
jc_coop <- read_csv("data/clean_cooperatives_data.csv")

#EDF turf data
edf_turf <- read_excel("data/EDF_TURF_data.xlsx")

```


Important/Necessary Data
tcbest.data #the best estimate of catch for that stock
tbbest.dat # the best estimate of biomass for that stock
divbpref # B/bmsy
divupref.data # u/umsy


Juliette Notes:

Handy functions for updating data frames:
match()
separate()

Useful Websites:
https://uc-r.github.io/tidyr

#RAM data wrangling
```{r}
ram <- timeseries_values_views %>%
  select("stocklong", "year", "TBbest", "TCbest", "BdivBmsypref", "UdivUmsypref") %>%
  add_column("RAM")

colnames(ram) <- c( "CommName", "Year", "Biomass", "Catch", "BvBmsy", "FvFmsy", "DBase")

#ram_2012 <- ram %>%
#  filter(Year > "2012") 
##this wont work because projection data has projected out past 2012. need to UPDATE

#updated 
#projection_ram <- bind_rows(list(projection_data, ram_2012))

2012-1950
#62
2050- 2012
#38
162+38

acheck <- filter(projection_ram, Year == "2013") %>%
  select("IdOrig", "CommName", "Year", "Biomass")

acheck_count <- unique(acheck$IdOrig)
acheck_count
#4714

yearcheck <- unique(projection_data$Year)
yearcheck
#101 years starts 1950 end 2050

join_project_ram <- join(projection_data, ram, by = c("CommName", "Year"), type = "full")

projectramcheck <- filter(join_project_ram, IdOrig == "NA")
#returns no rows with NA, could still be right if updated projected 

#Checking to see if better way to do join
# end up with WAY to many rows, something is off
#unite_projection_commname <- projection_data %>% 
#  unite(name_year, CommName, Year, sep = "-")
#unite_ram_commname <- ram %>% 
#  unite (name_year, CommName, Year, sep = "-")
#join_project_ram_2 <- join(unite_projection_commname, unite_projection_commname, by = "name_year", type = "left")

match_project_ram <- match(projection_data, ram)

```


#Data Wrangling: Projection and Countries ITQ
```{r}

#seperate out IdOrig column for Projection Data
separate_projection <- projection_ram %>% separate(IdOrig, c("agency", "stock", "t0", "tf", "data_enterer"))
    ###unsure what the last column actually is, double check

head(separate_projection, 10)

#reunite just the two parts we care about: agency and stock
unite_projection <- separate_projection %>% unite(assess_id_short, agency, stock, sep = "-")

#simplifying Countries ITQ with unique columns to prepare to merge
countries_ITQ_simple <- select(countries_ITQ, "assess_id_short", "year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")

#rename year to be capitalized to merge with projection data
colnames(countries_ITQ_simple) <- c("assess_id_short", "Year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")


ITQ_projection_merge <- merge(unite_projection, countries_ITQ_simple, by = c("assess_id_short", "Year"), all = TRUE)


#cleaning it up
ITQ_projection <- ITQ_projection_merge %>% unite(IdOrig, assess_id_short, t0, tf, data_enterer, sep = "-")

```

Playing with Data

#Total number of species with stocks
#Number of stocks with ITQs implemented
```{r}
IdOrig <- unique(ITQ_projection$SciName)
IdOrig
#1228 species total

ITQ_projection_implemented <- filter(ITQ_projection, programstart != "NA")

IdOrig_implemented <- unique(ITQ_projection_implemented$SciName)
IdOrig_implemented
#80 species with ITQ implemented
```


#Graphs for fun

ABARES_BGRDRSE
implemented ITQs in 1992
```{r}

ABARES_BGRDRSE <- filter(ITQ_projection, IdOrig == "ABARES-BGRDRSE-1960-2011-CHING")

graph_ABARES_BGRDRSE <-ggplot(ABARES_BGRDRSE, aes(x=Year, y=Biomass))+
  geom_line(size=1)+
  ggtitle("ABARES_BGRDRSE (Australia")+
  geom_point()+
  geom_line()+
  labs(x="Year", y="Yearly total biomass")+
  theme_classic()+
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  geom_vline(xintercept = 1992)+
  theme(legend.title=element_blank())

ggplotly(graph_ABARES_BGRDRSE)

#figure out an if then statement for line?


```


ADFG-HERRTOGE
never implemented ITQs
```{r}
ADFG_HERRTOGE <- filter(ITQ_projection, IdOrig == "ADFG-HERRTOG-1990-2010-HIVELY")

graph_ADFG_HERRTOGE <-ggplot(ADFG_HERRTOGE, aes(x=Year, y=Biomass))+
  geom_line(size=1)+
  ggtitle("ADFG-HERRTOGE (USA)")+
  geom_point()+
  geom_line()+
  labs(x="Year", y="Yearly total biomass")+
  theme_classic()+
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  theme(legend.title=element_blank())

ggplotly(graph_ADFG_HERRTOGE)

#figure out an if then statement for line?
```

Important/Necessary Data
tcbest.data #the best estimate of catch for that stock
tbbest.dat # the best estimate of biomass for that stock
divbpref # B/bmsy
divupref.data # u/umsy




Attempts at updating ITQ_projection with Rams
#asked ana about this -> waiting to hear back
```{r}

##this doesn't work; gives you vector not updated data frame
RAMS_ITQ_projection <- match(ITQ_projection_year$CommYear, ram_merge$CommYear)

#what happens when i just merge the two?
#test_merge <- merge(ITQ_projection_year, ram_merge, by = c("Name_Year"))


```


##edf turf data wrangling
# waiting for data from Gina if its more comprehensive than the EDF one
```{r}

edf_turf_unite <- edf_turf %>% unite(SciName, genus, species, sep = " ")

edf_turf_simple <- select(edf_turf_unite, "country", "start_date", "SciName")

colnames(edf_turf_simple) <- c("Country", "turfstart", "SciName")

##want to merge the edf simple with ITQ/Projections but maybe wait for Gina to respond with her TURF data
##in ITQ data says only one species of fish in japan has TURFs but not true

edf_projection_itq <- merge(ITQ_projection, edf_turf_simple, by = c("Country", "SciName"))
#only three species from the EDF data match with the species from the upside/projection data; all in Japan

```


Need to create new dataset (half upside half ITQ): Species, turf/itq, country,and then matching all the parameters with the species

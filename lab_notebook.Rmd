---
title: "lab_notebook"
author: "Juliette Verstaen"
date: "November 2, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Loading packages
```{r}

suppressPackageStartupMessages({
  library(tidyverse)
  library(tidyr)
  library(here)
  library(ggplot2)
  library(dplyr)
  library(readxl)
  library(devtools)
  library(plotly)
  library(base)
  library(rio)
  library(plyr)
  library(data.table)
})


```

#converting projection csv into rds
no longer need the code because have already used it to create the files
```{r}

#Upside data
#projection_data_csv <- read_csv("data/ProjectionData.csv")

#saveRDS(projection_data_csv, "projection_data.rds")

#WDPA_Nov2018.csv <- read_csv("data/WDPA_Nov2018.csv")

#saveRDS(WDPA_Nov2018.csv, "WDPA_Nov2018.rds")

```



#Load Data
```{r}

#Corbet data: when countries began using RBFs
countries_ITQ <- read_excel("data/Countries_ITQ.xlsx")

#Upside data
projection_data <- readRDS("data/projection_data.rds")

#MPA data
MPA <- readRDS("data/WDPA_Nov2018.rds")

#RAMS
load("data/DBdata-model_fits_included.RData")

#number_species <- unique(stock$scientificname)
#341 different species

#cooperative data from "Conservation incentives and collective choices in cooperative fisheries" paper (Ovando et al 2013)
jc_coop <- read_csv("data/clean_cooperatives_data.csv")

#EDF turf data
edf_turf <- read_excel("data/EDF_TURF_data.xlsx")

```


Important/Necessary Data
tcbest.data #the best estimate of catch for that stock
tbbest.dat # the best estimate of biomass for that stock
divbpref # B/bmsy
divupref.data # u/umsy


Juliette Notes:

Handy functions for updating data frames:
match()
separate()

Useful Websites:
https://uc-r.github.io/tidyr

#RAM data wrangling
```{r}
ram <- timeseries_values_views %>%
  select("stocklong", "year", "TBbest", "TCbest", "BdivBmsypref", "UdivUmsypref") %>%
  add_column("RAM")

colnames(ram) <- c( "CommName", "Year", "Biomass", "Catch", "BvBmsy", "FvFmsy", "DBase")

#ram_2012 <- ram %>%
#  filter(Year > "2012") 
##this wont work because projection data has projected out past 2012. need to UPDATE

#updated 
#projection_ram <- bind_rows(list(projection_data, ram_2012))

2012-1950
#62
2050- 2012
#38
162+38

acheck <- filter(projection_ram, Year == "2013") %>%
  select("IdOrig", "CommName", "Year", "Biomass")

acheck_count <- unique(acheck$IdOrig)
acheck_count
#4714

yearcheck <- unique(projection_data$Year)
yearcheck
#101 years starts 1950 end 2050

join_project_ram <- join(projection_data, ram, by = c("CommName", "Year"), type = "full")

projectramcheck <- filter(join_project_ram, IdOrig == "NA")
#returns no rows with NA, could still be right if updated projected 

#Checking to see if better way to do join
# end up with WAY to many rows, something is off
#unite_projection_commname <- projection_data %>% 
#  unite(name_year, CommName, Year, sep = "-")
#unite_ram_commname <- ram %>% 
#  unite (name_year, CommName, Year, sep = "-")
#join_project_ram_2 <- join(unite_projection_commname, unite_projection_commname, by = "name_year", type = "left")

match_project_ram <- match(projection_data, ram)

```


#Data Wrangling: Projection and Countries ITQ
```{r}

#seperate out IdOrig column for Projection Data
separate_projection <- projection_ram %>% separate(IdOrig, c("agency", "stock", "t0", "tf", "data_enterer"))
  

head(separate_projection, 10)

#reunite just the two parts we care about: agency and stock
unite_projection <- separate_projection %>% unite(assess_id_short, agency, stock, sep = "-")

#simplifying Countries ITQ with unique columns to prepare to merge
countries_ITQ_simple <- select(countries_ITQ, "assess_id_short", "year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")

#rename year to be capitalized to merge with projection data
colnames(countries_ITQ_simple) <- c("assess_id_short", "Year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")


ITQ_projection_merge <- merge(unite_projection, countries_ITQ_simple, by = c("assess_id_short", "Year"), all = TRUE)


#cleaning it up
ITQ_projection <- ITQ_projection_merge %>% unite(IdOrig, assess_id_short, t0, tf, data_enterer, sep = "-")

```

Playing with Data

#Total number of species with stocks
#Number of stocks with ITQs implemented
```{r}
IdOrig <- unique(ITQ_projection$SciName)
IdOrig
#1228 species total

ITQ_projection_implemented <- filter(ITQ_projection, programstart != "NA")

IdOrig_implemented <- unique(ITQ_projection_implemented$SciName)
IdOrig_implemented
#80 species with ITQ implemented
```


#Graphs for fun

ABARES_BGRDRSE
implemented ITQs in 1992
```{r}

ABARES_BGRDRSE <- filter(ITQ_projection, IdOrig == "ABARES-BGRDRSE-1960-2011-CHING")

graph_ABARES_BGRDRSE <-ggplot(ABARES_BGRDRSE, aes(x=Year, y=Biomass))+
  geom_line(size=1)+
  ggtitle("ABARES_BGRDRSE (Australia")+
  geom_point()+
  geom_line()+
  labs(x="Year", y="Yearly total biomass")+
  theme_classic()+
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  geom_vline(xintercept = 1992)+
  theme(legend.title=element_blank())

ggplotly(graph_ABARES_BGRDRSE)

#figure out an if then statement for line?


```


ADFG-HERRTOGE
never implemented ITQs
```{r}
ADFG_HERRTOGE <- filter(ITQ_projection, IdOrig == "ADFG-HERRTOG-1990-2010-HIVELY")

graph_ADFG_HERRTOGE <-ggplot(ADFG_HERRTOGE, aes(x=Year, y=Biomass))+
  geom_line(size=1)+
  ggtitle("ADFG-HERRTOGE (USA)")+
  geom_point()+
  geom_line()+
  labs(x="Year", y="Yearly total biomass")+
  theme_classic()+
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  theme(legend.title=element_blank())

ggplotly(graph_ADFG_HERRTOGE)

#figure out an if then statement for line?
```

Important/Necessary Data
tcbest.data #the best estimate of catch for that stock
tbbest.dat # the best estimate of biomass for that stock
divbpref # B/bmsy
divupref.data # u/umsy




Attempts at updating ITQ_projection with Rams
#asked ana about this -> waiting to hear back
```{r}

##this doesn't work; gives you vector not updated data frame
RAMS_ITQ_projection <- match(ITQ_projection_year$CommYear, ram_merge$CommYear)

#what happens when i just merge the two?
#test_merge <- merge(ITQ_projection_year, ram_merge, by = c("Name_Year"))


```


##edf turf data wrangling
# waiting for data from Gina if its more comprehensive than the EDF one
```{r}

edf_turf_unite <- edf_turf %>% unite(SciName, genus, species, sep = " ")


edf_turf_simple <- edf_turf_unite %>%
  add_column("turf") %>%
  select("country", "start_date", "SciName") %>%
  gsub('\\bNA NA\\b', 'NA')

colnames(edf_turf_simple) <- c("Country", "turfstart", "SciName")

##want to merge the edf simple with ITQ/Projections but maybe wait for Gina to respond with her TURF data
##in ITQ data says only one species of fish in japan has TURFs but not true

edf_projection_itq <- merge(ITQ_projection, edf_turf_simple, by = c("Country", "SciName"))
#only three species from the EDF data match with the species from the upside/projection data; all in Japan

```


Need to create new dataset (half upside half ITQ): Species, turf/itq, country,and then matching all the parameters with the species


################
################
###############
PART 2
1) pull the ITQ, IVQ, IQ fisheries out of upside.
2) pull the TURF fisheries from EDF.
3) For each fishery, we want species, location, and ITQ vs. TURF.

From updating_projection.R script file
```{r}

#Load Data
#Upside data
projection_data <- readRDS("data/projection_data.rds")

#RAMS
load("data/DBdata-model_fits_included.RData")

#Corbet data: when countries began using RBFs
countries_ITQ <- read_excel("data/Countries_ITQ.xlsx")



#RAM Data Tiddying
ram <- timeseries_values_views %>%
  select("stocklong", "year", "TBbest", "TCbest", "BdivBmsypref", "UdivUmsypref") %>%
  add_column("RAM")

colnames(ram) <- c( "CommName", "Year", "Biomass", "Catch", "BvBmsy", "FvFmsy", "DBase")


#Update Projection with RAM
projection_updated <- join(projection_data, ram, by = c("CommName", "Year"), type = "full")

#Merge Projection and ITQ
#seperate out IdOrig column for Projection Data
separate_projection <- projection_updated %>% separate(IdOrig, c("agency", "stock", "t0", "tf", "data_enterer"))

head(separate_projection, 10)

#reunite just the two parts we care about: agency and stock
unite_projection <- separate_projection %>% unite(assess_id_short, agency, stock, sep = "-")

#simplifying Countries ITQ with unique columns to prepare to merge
countries_ITQ_simple <- select(countries_ITQ, "assess_id_short", "year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")

#rename year to be capitalized to merge with projection data
colnames(countries_ITQ_simple) <- c("assess_id_short", "Year", "yearitq", "region_id", "idnumber", "harvest_fb", "itq_now", "iq", "itq", "ivq", "coop", "communityquota", "turf", "individualeffort", "iteq", "totalappliedeffort", "producerorg", "aquaculture", "programstart")

ITQ_projection_merge <- merge(unite_projection, countries_ITQ_simple, by = c("assess_id_short", "Year"), all = TRUE)

#cleaning it up
ITQ_projection <- ITQ_projection_merge %>% unite(IdOrig, assess_id_short, t0, tf, data_enterer, sep = "-")

#create RDS from dataframe
saveRDS(ITQ_projection, "ITQ_projection.rds")


#simplified projection data
ITQ_projection_simple <- ITQ_projection %>%
  select("Country", "Year", "CommName", "SciName", "SpeciesCat", "CatchShare", "Catch", "Biomass", "BvBmsy", "FvFmsy","MSY", "Price", "g", "k", "c", "phi", "yearitq", "itq_now","iq", "itq", "ivq", "turf", "programstart")

#create RDS from dataframe
#saveRDS(ITQ_projection_simple, "projection_updated.rds")

#upside updated
upside_2018_updated <- ITQ_projection %>%
  select("Country", "Year", "CommName", "SciName", "SpeciesCat", "CatchShare", "Catch", "Biomass", "BvBmsy", "FvFmsy","MSY", "Price", "g", "k", "c", "phi")

#create RDS from dataframe
#saveRDS(upside_2018_updated, "upside_2018_updated")

```



#load data
```{r}

# create dataframe with 
ITQ_projection <- readRDS("processed_data/ITQ_projection.rds")

itq <- ITQ_projection %>%
  select("Country", "SciName", "itq_now","iq", "itq", "ivq", "turf", "programstart")

#Load EDF TURF data

edf_turf <- read_excel("data/EDF_TURF_data.xlsx")

#load in DiscoverTURFs data

d_turfs <- read_excel("data/DiscoverTURFs_simple.xlsx")

```


#data wrangling
```{r}


edf_turf_simple <- select(edf_turf, "country", "start_date", "SciName", "turf")
#create new column that says "turf" and TRUE or FALSE


colnames(edf_turf_simple) <- c("Country", "programstart", "SciName", "turf")

#combining edf turf data from upside data
edf_projection_1 <- join(edf_turf_simple, itq, by = c("Country", "programstart", "SciName", "turf"), type = "full")

#combine edf/upside with discover turfs
all_turf_1 <- join(edf_projection_1, d_turfs, by = c("Country", "SciName", "turf"), type = "full")

#change "blank" NAs to real NAs
#all_turf_1[is.na(all_turf_1)] <- "NA"

#rearrange columns
all_turf_itq <- all_turf_1[, c(1,3,2,5,6,7,8,4)]

#turning NAs from no ITQ data to FALSE
#all_turf_2[all_turf_2 == 0] <- NA

all_turf_itq$iq[is.na(all_turf_itq$iq)] <- FALSE

all_turf_itq$itq[is.na(all_turf_itq$itq)] <- FALSE

all_turf_itq$ivq[is.na(all_turf_itq$ivq)] <- FALSE

all_turf_itq$itq_now[is.na(all_turf_itq$itq_now)] <- 0

#create RDS from dataframe
#saveRDS(all_turf_itq, "all_turf_itq.rds")
#write.csv(all_turf_itq, file = "all_turf_itq.csv")


```

###################
##################

Part 3

1) include only species that are either TURF, ITQ, IVQ, etc. (omit species that are FALSE for everything).
2) Include each fishery only once (not multiple years).
3) so then see how hard it is to collect other characteristics for each species (like growth rate or ISCAAP category).

1 & 2
```{r}

#filter out all countries that don't have itqs or turfs
true_turf_itq_1 <- all_turf_itq %>%
  filter (iq == "TRUE" | itq == "TRUE" | ivq == "TRUE" | turf == "TRUE") %>%
  filter( Country != "NA") %>%
  select("Country", "SciName", "iq", "itq", "ivq", "turf") 
  

true_turf_itq <- unique(true_turf_itq_1 [ , 1:6])

unique(true_turf_itq$Country)
#33 countries
#Chile, Fiji, Italy, Japan, Mexico, Papua New Guinea, Samoa, Solomon Islands, Spain, Sri Lanka, Sweden, Vanuatu, Vietnam, Australia, USA, Canada, Peru, Argentina, South Africa, New Zealand, American Samoa, Belize, Brazil, Ecuador, France, Greece, India, Netherlands, Nigeria, Philippines, St Lucia, United States, United Kingdom  

#chile_itq_turf <- filter(true_turf_itq, Country == "Chile")
#unique(chile_itq_turf$SciName)
# 67

#fiji_itq_turf <- filter(only_turf_itq, Country == "Fiji")
#unique(fiji_itq_turf$SciName)

#test_duplicate <- unique(fiji_itq_turf[ , 1:8])


```


3
ISCAAP
```{r}

iscaap_cat_1 <- upside_2018_updated %>%
  select("SciName", "SpeciesCat") 

iscaap_cat <- unique(iscaap_cat_1 [ , 1:2])

true_turf_itq_iscaap_1 <- merge(true_turf_itq, iscaap_cat, by = "SciName", all = T)

true_turf_itq_iscaap <- true_turf_itq_iscaap_1 %>%
  filter( itq != "NA" & ivq != "NA" & iq != "NA" & turf != "NA") 

true_turf_itq_iscaap[is.na(true_turf_itq_iscaap)] <- "NA"

missing_speccat <- true_turf_itq_iscaap %>%
  filter(SpeciesCat == "NA")

#write.csv(true_turf_itq_iscaap, file = "true_turf_itq_iscaap.csv")

determine_spec_cat <- as.vector(missing_speccat$SciName)
determine_spec_cat


```

FishBase

```{r}

library("rfishbase")

species <- as.vector(true_turf_itq_iscaap$SciName)
species

table_species <- species(species)

growth <- popgrowth(species)

#fishtest <- species_list(Genus = "Labroides")
#fishtest
#species(fishtest)
#even running the practice online tutorial get this error :Error in curl::curl_fetch_memory(url, handle = handle) : Timeout was reached: Connection timed out after 10004 milliseconds

#fishbase_test <- validate_names(species, fields = c("Species", ""))



```

FAO website with fisheries data is currently unavaliable. Updated by hand for now; read in below 
```{r}
species_rightsbased <- read_csv("data/species_rightsbased.csv")

ISSCAAP_species <- select(species_rightsbased, SciName, SpeciesCat)
#write.csv(ISSCAAP_species, file ="ISSCAAP_species.csv")
```
-	used FAO 3-Alpha species codes (ASFIS) updated 2/2009
-	ones with no ISSCAPP # still are shellfish, snails, crabs, not species specific, common name, species in NA, or a family name with more than 1 #



###########

Part 4:
For TURF/ITQ data, add GDP/capita for each country, also do ISCAAP categories. Combine all ITQ,IQ etc. Run logit of Prob(ITQ) = f(ISCAAP, GDP).
```{r}

species_rightsbased_binary <- read_csv("data/species_rightsbased_binary.csv")

upside_2018_updated <- readRDS("/GitHub/global_fisheries_managment/processed_data/upside_2018_updated.rds")

gdp_all <- read_csv("/GitHub/global_fisheries_managment/data/gpd.csv")


```


```{r}

gdp <- filter(gdp_all, current_gdp != "NA")

join_gdp_rightsbased <- join(gdp, species_rightsbased_binary, by = c("Country"), type = "full")

gdp_rightsbased <- filter(join_gdp_rightsbased, SpeciesCat != "NA" )

#write.csv(gdp_rightsbased, file = "gdp_rightsbased.csv")


```


```{r}


##make sure that these stats are not effected by year 2012 onward not having info on itq or not. i think this data was not year specific so it should be fine? but look at the data 

gdp_rightsbased$SpeciesCat <- factor(gdp_rightsbased$SpeciesCat)

itq_glm <- glm(formula = i_right ~ current_gdp + SpeciesCat, family = "binomial", data = gdp_rightsbased)
itq_glm

summary(itq_glm)

#turf_glm <- glm(turf ~ current_gdp + SpeciesCat, family = "binomial", data = gdp_rightsbased)
#turf_glm
#summary(turf_glm)

```

Part 5:
RAM only: F/Fmsy vs. B/Bmsy for all fisheries. Color ITQ differently. 

2. From upside sorts KOBE: ITQ versus non ITQ and the size of dot is the catch
#this is all the data we have, make the same ones with only certain years and such

```{r}

ITQ_projection <- readRDS("processed_data//not_actively_used/ITQ_projection.rds")


f_b_itq <- ITQ_projection %>%
  select("BvBmsy", "FvFmsy", "itq", "iq", "ivq", "turf", "Catch") %>%
  filter( itq != "NA", iq != "NA", ivq != "NA") %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0"))

#turf == TRUE ~ "2",
#write.csv(f_b_itq, file = "f_b_itq.csv")
#f_b_irights <- read_csv("data/f_b_irights.csv")
#this was when i couldn't figure out how to do the if then statement in R

#F_B_graph <- ggplot(data = f_b_irights, aes( x=BvBmsy, y=FvFmsy, colour= i_rights, size = catch ))+

# get data frame that was
F_B_graph <- ggplot(data = f_b_itq, aes( x=BvBmsy, y=FvFmsy, colour= rightsbased, size = Catch ))+
  geom_point()+
  labs(x = "B/Bmsy", y= "F/Fsmy") +
  theme_minimal()+
  theme(legend.title=element_blank())+
  ylim(-1, 5)+
  xlim(-.3, 3)+
  geom_hline(aes(yintercept=1))+
  geom_vline(aes(xintercept=1))

#F_B_graph
ggplotly(F_B_graph)

```









######
MPA data wrangling
######
```{r}

ISO_country_codes <- read_excel("data/ISO_country_codes.xlsx")
MPA <- readRDS("data/WDPA_Nov2018.rds")

mpa_simple <- MPA %>%
  select("NAME", "PA_DEF", "DESIG_ENG", "DESIG_TYPE", "IUCN_CAT", "MARINE", "REP_M_AREA", "NO_TAKE", "STATUS", "PARENT_ISO3") %>%
  filter(MARINE != "0")

colnames(mpa_simple) <- c("NAME", "PA_DEF", "DESIG_ENG", "DESIG_TYPE", "IUCN_CAT", "MARINE", "REP_M_AREA", "NO_TAKE", "STATUS", "code")

mpa_join <- join(mpa_simple, ISO_country_codes, by = c("code"), type = "full")

mpa_updated <- mpa_join %>%
  select("Country", "NAME", "DESIG_ENG", "DESIG_TYPE", "IUCN_CAT", "MARINE", "REP_M_AREA", "NO_TAKE", "STATUS" ) %>%
  filter(NAME != "NA" & DESIG_ENG != "NA" & DESIG_TYPE != "NA" & IUCN_CAT != "NA" & MARINE != "NA" & REP_M_AREA != "NA" & NO_TAKE != "NA" & STATUS != "NA")

#write.csv(mpa_updated, file = "mpa_updated.csv")

```

PA_DEF: Allowed values: 1 (meets IUCN and/or CBD PA definition); 0 (does not meet IUCN and/or CBD PA definition (currently stored outside WDPA)).

MARINE: Allowed values: 0 (100% Terrestrial PA), 1 (Coastal: marine and terrestrial PA), and 2 (100 % marine PA).

#############
############
1.	From upside want to know the catch in ITQ versus non ITQ for most recent year

- issues: unsure what year real data ends and projectio/modeling begins
- pretty sure its 2016. there are thee fisheries with 2017 data in the updated RAMS dataset but more for 2016

update recent years fisheries

issue: the projection data updated with RAMs doens't have ITQ data associated with the countries
- need a list of all the countries and whether or not they have ITQ in 2016 -> this can be pulled from Corbett's data. need to check if his data is from that year

1.	From upside want to know the catch in ITQ versus non ITQ for most recent year
corbet data only goes up until 2012 
```{r}

ITQ_projection <- readRDS("data/ITQ_projection.rds")

f_b_itq_countries <- ITQ_projection %>%
  select("BvBmsy", "FvFmsy", "itq", "iq", "ivq", "turf", "Catch", "Year", "Country", "IdOrig") %>%
  filter( itq != "NA", iq != "NA", ivq != "NA") %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0")) 

countries_itq_2012 <- f_b_itq_countries %>%
  select (Country, rightsbased, Year, IdOrig, Catch) %>%
  filter(Year == "2012") 

ITQ_projection_2016 <- ITQ_projection %>%
  filter(Year == "2016") %>%
  select(IdOrig, Country)

itq_2016_updated <- join(ITQ_projection_2016, countries_itq_2012, by= c("IdOrig", "Country"), type= "full")

itq_2016_rightsbasedTRUE <- filter(itq_2016_updated, rightsbased == "1")

itq_2016_rightsbasedFALSE <- filter(itq_2016_updated, rightsbased == "0")

itq_2016_rightsbasedTURF <- filter(itq_2016_updated, rightsbased == "2")


sum(itq_2016_rightsbasedTRUE$Catch, na.rm = TRUE)
#27,830,933
sum(itq_2016_rightsbasedFALSE$Catch, na.rm = TRUE)
#266,328,075

sum(itq_2016_rightsbasedTURF$Catch, na.rm = TRUE)
#1505000

```

updating projection datapast 2012  with the 2012 itq fisheries
```{r}
ITQ_projection <- readRDS("data/ITQ_projection.rds")

f_b_itq_countries <- ITQ_projection %>%
  select("BvBmsy", "FvFmsy", "itq", "iq", "ivq", "turf", "Catch", "Year", "Country", "IdOrig") %>%
  filter( itq != "NA", iq != "NA", ivq != "NA") %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0")) 

countries_itq_2012 <- f_b_itq_countries %>%
  select (Country, rightsbased, Year, IdOrig, Catch) %>%
  filter(Year == "2012") 

ITQ_projection_past2012 <- ITQ_projection %>%
  filter(Year > 2012) 

ITQ_projection_past2012UPDATED <- join(ITQ_projection_past2012, countries_itq_2012, by = c("Country", "Year", "IdOrig"), type = "full" )

ITQ_projection_pre2012 <- ITQ_projection %>%
  filter(Year <= 2012)

ITQ_projection_updated <- join(ITQ_projection_past2012UPDATED,ITQ_projection_pre2012, by = c("Country", "Year", "IdOrig"), type = "full")

#saveRDS(ITQ_projection_updated, "ITQ_projection_updated.rds")

ITQ_projection_updated <- readRDS("data/ITQ_projection_updated.rds")

f_b_itq_updated <- ITQ_projection_updated %>%
  select("BvBmsy", "FvFmsy", "itq", "iq", "ivq", "turf", "Catch") %>%
  filter( itq != "NA", iq != "NA", ivq != "NA") %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0"))


F_B_graph_updated <- ggplot(data = f_b_itq_updated, aes( x=BvBmsy, y=FvFmsy, colour= rightsbased, size = Catch ))+
  geom_point()+
  labs(x = "B/Bmsy", y= "F/Fsmy") +
  theme_minimal()+
  theme(legend.title=element_blank())+
  ylim(-1, 5)+
  xlim(-.3, 3)+
  geom_hline(aes(yintercept=1))+
  geom_vline(aes(xintercept=1))

#F_B_graph
ggplotly(F_B_graph_updated)

```







###Did this chunck before figured out how to do if/then statements in r

```{r}
ITQ_projection <- readRDS("data/ITQ_projection.rds")

#filter down the data to create a data set of countries that have ITQs so I can add that to the rams data. upside has this info but not the updated part

#2012 is the most updated version of the upside data. used this to figure out which counties have ITQs and will make a data frame from that of a list of countires that have itqs and then update the final datafram (or inital rams dataframe)
countries_with_ITQ <- ITQ_projection %>%
  select (Country, itq, iq, ivq, Year, IdOrig) %>%
  filter(Year == "2012") 

countries_with_ITQ_2 <- unique(countries_with_ITQ[, 1:6])
countries_with_ITQ_3 <- filter(countries_with_ITQ_2, itq != "NA" | iq != "NA" | ivq != "NA")

countries_with_ITQ_3$rightsbased <- 1
countries_itq_2012 <- select(countries_with_ITQ_3, Country, IdOrig, rightsbased)

#now need to create new column thats rights based fishereise 0 o for projection 2016

ITQ_projection_2016 <- ITQ_projection %>%
  filter(Year == "2016") %>%
  select(IdOrig, Country, Catch)

itq_2016_updated <- join(ITQ_projection_2016, countries_itq_2012, by= c("IdOrig", "Country"), type= "full")

itq_2016_updated$rightsbased[is.na(itq_2016_updated$rightsbased)] <- 0

#seperate rights based and not
itq_2016_rightsbasedTRUE <- filter(itq_2016_updated, rightsbased == "1")

itq_2016_rightsbasedFALSE <- filter(itq_2016_updated, rightsbased == "0")

sum(itq_2016_rightsbasedTRUE$Catch, na.rm = TRUE)
#27,830,933
sum(itq_2016_rightsbasedFALSE$Catch, na.rm = TRUE)
#266,328,075

##units???


```

###Need to update the ITQ_projection rds file and the ITQ_projection_updated rds file (1st file is without applying ITQ info past 2012 and the second is)

##ADD THIS INTO THE SCRIPT FOR UPDATING UPSIDE DATA
```{r}
ISSCAAP_species <- read_csv("data/ISSCAAP_species.csv")
ITQ_projection <- readRDS("data/ITQ_projection.rds")

ITQ_projection_isscaap_1 <- join(ISSCAAP_species,ITQ_projection, by = c("SciName", "SpeciesCat"), type = "full" )

ITQ_projection_isscaap <- ITQ_projection_isscaap_1 %>%
  filter(Country != "NA") 


```




In the updated ITQ projection data there are lines of data that have 2012 with NA instead of TRUE/FALSE for itq. 

#data we have says that Mexico does not have ITQs?
in 2012 only ones it says we have are Australia, USA, Canda, Japan, Peru, Argentina, South Africa, New Zealand

Fixing upside data
- take ITQ projection an filter it down to idorig, year, BvBmsy", "FvFmsy", "itq", "iq", "ivq"
- filter out just ones with itqs, create a column thats rights based fisherse and make it one
- filter out specifics of itq
- merge/join that data with the countries_itq2012 with country, idorig, and rihgts based
- make nas zero
-redo kobe plot with this data
- also cut off at 5


#this was from before figured out if then statement

ITQ_projection <- readRDS("data/ITQ_projection.rds")

itq_selected <- ITQ_projection %>%
  select(IdOrig,Country, Year, BvBmsy, FvFmsy, itq, iq, ivq) %>%
  filter(itq != "NA" | iq != "NA" | ivq != "NA") 

itq_selected$rightsbased <- 1

itq_selected_2 <- select(itq_selected,Country, IdOrig, Year, rightsbased)

itq_new_join <- join(itq_selected_2, countries_itq_2012, by = c(Country, IdOrig, Year), type = "full")

##not using this anymore

ITQ_projection <- readRDS("processed_data//not_actively_used/ITQ_projection.rds")

countries_with_ITQ <- ITQ_projection %>%
  select (Country, itq, iq, ivq, Year, IdOrig) %>%
  filter(Year == "2012") 

countries_with_ITQ_2 <- unique(countries_with_ITQ[, 1:6])
countries_with_ITQ_3 <- filter(countries_with_ITQ_2, itq != "NA" | iq != "NA" | ivq != "NA")

countries_with_ITQ_3$rightsbased <- 1
countries_itq_2012 <- select(countries_with_ITQ_3, Country, IdOrig, rightsbased)

##need to update projection data


f_b_itq <- ITQ_projection %>%
  select("BvBmsy", "FvFmsy", "itq", "iq", "ivq") %>%
  filter( itq != "NA", iq != "NA", ivq != "NA")

ISSCAAP Codes and the non-species specific codes
```{r}

meta_isscaap_codes_1 <- join(isscaap_codes, ISSCAAP_species, by = c("SciName", "SpeciesCat"), type = "full")

meta_isscaap_codes <- unique( meta_isscaap_codes_1[ , 1:2 ] )
write_csv(meta_isscaap_codes, "meta_isscaap_codes.csv")
```


12/18/2018
Using the newly updated upside/ITQ and filtering out only the most recent date for each fishery
- make a df of these that have ITQs and those that don't -> apply to OG upside/ITQ data so that more recent years can have ITQ data
- take this new df and filter out the most recent years with ITQs and KOBE plot. also do catches

```{r}

ITQ_projection <- readRDS("data/ITQ_projection.rds")

upside_2016 <- ITQ_projection %>%
  filter(Year <= "2016") %>%
  unite(id_country, IdOrig, Country, sep = "-")

upside_recent <- setDT(upside_2016)[,.SD[which.max(Year)],keyby=id_country]

upside_allfisheriesITQ <- upside_recent %>%
  select (id_country, itq, iq, ivq, Year, turf) %>%
  filter(itq != "NA" & iq != "NA" & ivq != "NA" ) 

```

#Pulling out information about ITQs/TURFs in Corbette Data to apply to upside data
```{r}

Countries_ITQ <- read_excel("data/Countries_ITQ.xlsx")

#new dataframw with just most recent year of data for each fishery
corbette_recent <- setDT(Countries_ITQ)[,.SD[which.max(year)],keyby=assess_id_short]

#filter out the fisheries with no data on itqs or turfs
corbette_fisheries <- corbette_recent %>%
  select(assess_id_short, year, speciescat, iq, itq, ivq, coop, turf)%>%
  filter(itq != "NA" & iq != "NA" & ivq != "NA")%>%
  filter(turf != "NA" ) 


#new data frame with just data on fisheries with itqs
fisheries_with_itq <- corbette_fisheries %>%
   filter(itq == "TRUE" | iq == "TRUE" | ivq == "TRUE" | turf == "TRUE" )

```

reupdating upside data with new ITQ list

```{r}
#Load Data
#Upside data
projection_data <- readRDS("data/projection_data.rds")

#RAMS
load("data/DBdata-model_fits_included.RData")


#RAM Data Tiddying
ram <- timeseries_values_views %>%
  select("stocklong", "year", "TBbest", "TCbest", "BdivBmsypref", "UdivUmsypref") %>%
  add_column("RAM")

colnames(ram) <- c( "CommName", "Year", "Biomass", "Catch", "BvBmsy", "FvFmsy", "DBase")

#Update Projection with RAM
projection_updated <- join(ram, projection_data, by = c("CommName", "Year"), type = "full")
##note: RAM data has some fisheries not in the projection data, thus adding new fisheries to the upside projection data

#separate and unit functions to create a shorter version of the stock assessment ID to merge with corbette ITQ/TURF data later
separate_projection <- projection_updated%>% 
  separate(IdOrig, c("agency", "stock", "t0", "tf", "data_enterer"))

unite_projection <- separate_projection %>% 
  unite(assess_id_short, agency, stock, sep = "-")

colnames(fisheries_with_itq) <- c("assess_id_short", "Year","SpeciesCat" , "iq", "itq", "ivq", "coop", "turf")

#merge corbette's data on ITQ/Turf implemented or not for each fishery
fishery_itq_simple <- fisheries_with_itq %>%
  select(assess_id_short,iq, itq, ivq, turf )

ITQ_projection_merge <- merge(unite_projection, fisheries_with_itq, by = c("assess_id_short"), all = TRUE)

#filter out data post 2016 because we know that those are projected/modeled data not recorded
recent_pre2016 <- ITQ_projection_merge %>%
  filter(Year.x <= "2016")

#keep only info on most recent year for each fishery  
fisheries_recent_1 <- setDT(recent_pre2016)[,.SD[which.max(Year.x)],keyby=assess_id_short]

#select the columns we are interested in
fisheries_recent <- fisheries_recent_1 %>%
  select(Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq, turf)

#write dataframe to csv file
#fisheries_recent <- write.csv(fisheries_recent, file = "fisheries_recent.csv")

```

##KOBE Plots with only most recent year of fisheries
RAM only
No data: ITQ = FALSE

```{r}

#read in data: this is updated projection data (updated using RAMs) and Corbett's ITQ/Turf data applied to each fishery. only data for most recent year for each fishery is represented.

fisheries_recent <- read_csv("data/fisheries_recent.csv")

#assuming that when no data is avaliable on the fishery inregardes to ITQ or Turfs that means there are none
fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

#only looking at fisheries data that come from RAMS database
# creating new column called "rightsbased" where 1 = ITQ and 0 = No ITQ
fisheries_KOBE_ram <- fisheries_recent %>%
  filter(Dbase == "RAM") %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0")) 

#graphing logistics
fisheries_KOBE_ram$rightsbased[fisheries_KOBE_ram$rightsbased == "0"]<- "No ITQ"
fisheries_KOBE_ram$rightsbased[fisheries_KOBE_ram$rightsbased == "1"]<- "ITQ"

F_B_graph_RAM <- ggplot(data = fisheries_KOBE_ram, aes( x=BvBmsy, y=FvFmsy, colour= rightsbased, size = Catch ))+
  geom_point()+
  labs(x = "B/Bmsy", y= "F/Fsmy") +
  theme_minimal()+
  theme(legend.title=element_blank())+
  ylim(0, 2.5)+
  xlim(0, 2.5)+
  geom_hline(aes(yintercept=1))+
  geom_vline(aes(xintercept=1))+
  ggtitle("KOBE Plot: RAM only Fisheries")

#F_B_graph
ggplotly(F_B_graph_RAM)


```

##KOBE Plots with only most recent year of fisheries
RAM only
No data: ITQ = FALSE
```{r}

#read in data: this is updated projection data (updated using RAMs) and Corbett's ITQ/Turf data applied to each fishery. only data for most recent year for each fishery is represented.
fisheries_recent <- read_csv("data/fisheries_recent.csv")

#assuming that when no data is avaliable on the fishery inregardes to ITQ or Turfs that means there are none
fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

fisheries_KOBE <- fisheries_recent %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0")) 

fisheries_KOBE$rightsbased[fisheries_KOBE$rightsbased == "0"]<- "No ITQ"
fisheries_KOBE$rightsbased[fisheries_KOBE$rightsbased == "1"]<- "ITQ"

#graphing logistics
F_B_graph <- ggplot(data = fisheries_KOBE, aes( x=BvBmsy, y=FvFmsy, colour= rightsbased, size = Catch ))+
  geom_point()+
  labs(x = "B/Bmsy", y= "F/Fsmy") +
  theme_minimal()+
  theme(legend.title=element_blank())+
  ylim(0, 2.5)+
  xlim(0, 2.5)+
  geom_hline(aes(yintercept=1))+
  geom_vline(aes(xintercept=1))+
  ggtitle("KOBE Plot:  All Fisheries")

#F_B_graph
ggplotly(F_B_graph)

```

## adding turf information to upside projection(ie: fisheries_recent)
```{r}

#load in data for turf/itq only projection
turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf)

fisheries_recent_generousturf_1 <- select(fisheries_recent, Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq)

#merge the most recent data on each fishery with turf data
fisheries_recent_generousturf <- merge(fisheries_recent_generousturf_1, turf_only, by = c("Country", "SciName")) #, all = "TRUE")

#assuming that when no data is present for itqs/turf that means there are none
fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1"
    ))

#create dfs for turf, itq, and no itq fisheries to calculate the sum of each
#NOTE to rememeber: the data from these fisheries are the most recent numbers we have. they are not all in the same year 
turfs <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "2")
itq <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "1")
no_itq <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "0")

sum(turfs$Catch, na.rm = TRUE)

sum(itq$Catch, na.rm = TRUE)

sum(no_itq$Catch, na.rm = TRUE)


```


turf only = 413 rows
fisheries recent = 5294

5643 actual rows
5707 when manually added added
- this means 64 species were matched with existing species in database
- when separated out all by species it was worse

- separate remaining by genus?


12/20/2018
new UN GDP data, 2016 only
Scaled GDPs
Rerun Regressions
###itq or turf: probablity of itq = f(ISSCAPP and GDP)
*regression converges*
```{r}

fisheries_recent <- read_csv("data/fisheries_recent.csv")

fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf, SpeciesCat) 

fisheries_recent_generousturf_1 <- fisheries_recent %>%
  select(Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq)

fisheries_recent_generousturf <- merge(turf_only, fisheries_recent_generousturf_1, by = c("Country", "SciName"), all = "TRUE")

fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE | iq == FALSE | ivq == FALSE ~ "0"
    ))

gdp_all <- read_excel("data/un_gdp_2016.xls")

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 


join_gdp_rightsbased <- merge(gdp, fisheries_recent_generousturf_rightsbased, by = c("Country"))

gdp_rightsbased <- filter(join_gdp_rightsbased, SpeciesCat != "NA" )

gdp_rightsbased$SpeciesCat <- factor(gdp_rightsbased$SpeciesCat)
gdp_rightsbased$rightsbased <- as.numeric(gdp_rightsbased$rightsbased)
                              

itq_glm <- glm(formula = rightsbased ~ gdp_center + SpeciesCat, family = "binomial", data = gdp_rightsbased)
itq_glm

summary(itq_glm)

```

Run Turf versus ITQ probably: prob(ITQ). Turf = 1 and ITQ = 0 with the data set that was the turf/itq only one

```{r}
fisheries_recent <- read_csv("data/fisheries_recent.csv")

fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf, SpeciesCat) 

fisheries_recent_generousturf_1 <- fisheries_recent %>%
  select(Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq)

fisheries_recent_generousturf <- merge(turf_only, fisheries_recent_generousturf_1, by = c("Country", "SciName"), all = "TRUE")

fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "1",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "0"
    ))

gdp_all <- read_excel("data/un_gdp_2016.xls")

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 


join_gdp_rightsbased <- merge(gdp, fisheries_recent_generousturf_rightsbased, by = c("Country"))

gdp_rightsbased <- filter(join_gdp_rightsbased, SpeciesCat != "NA" )

gdp_rightsbased$SpeciesCat <- factor(gdp_rightsbased$SpeciesCat)
gdp_rightsbased$rightsbased <- as.numeric(gdp_rightsbased$rightsbased)
                              

itq_turf_glm <- glm(formula = rightsbased ~ gdp_center + SpeciesCat, family = "binomial", data = gdp_rightsbased)
itq_glm

summary(itq_turf_glm)


```

##Diagnostics

```{r}

##run above chunk to get gdp_rightsbased df not the old csv file that is now archived in data folder

diagnostics <- gdp_rightsbased %>%
  mutate(management = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    turf == TRUE ~ "2",
    itq == FALSE | iq == FALSE | ivq == FALSE | turf == FALSE ~ "0"
    )) %>%
  select(Country, gdp_center, SpeciesCat, management)

#diagnostics wont run with non-numeric?
diagnostics$SpeciesCat <- as.numeric(diagnostics$SpeciesCat)
diagnostics$management <- as.numeric(diagnostics$management)

#2= gdp; 4= turf; 5 = SpeciesCat; 23 = itq; 24= ivq; 25 = iq; 26= binary rights based
pairs(diagnostics[2:4]) 

#pearson's r correlations
cor(diagnostics[2:4]) 

#run chi square?


```
## MPA stuff


##12/23/2018

##KOBE Plots with only most recent year of fisheries
###RAM only
No data: ITQ = FALSE

```{r}

#read in data: this is updated projection data (updated using RAMs) and Corbett's ITQ/Turf data applied to each fishery. only data for most recent year for each fishery is represented.

fisheries_recent <- read_csv("data/fisheries_recent.csv")

#assuming that when no data is avaliable on the fishery inregardes to ITQ or Turfs that means there are none
fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

```


```{r}

#only looking at fisheries data that come from RAMS database
# creating new column called "rightsbased" where 1 = ITQ and 0 = No ITQ
fisheries_KOBE_ram <- fisheries_recent %>%
  filter(Dbase == "RAM") %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0")) 

#graphing 
fisheries_KOBE_ram$rightsbased[fisheries_KOBE_ram$rightsbased == "0"]<- "No ITQ"
fisheries_KOBE_ram$rightsbased[fisheries_KOBE_ram$rightsbased == "1"]<- "ITQ"

ggplot(data = fisheries_KOBE_ram, aes( x=BvBmsy, y=FvFmsy, colour= rightsbased, size = Catch ))+
  geom_point()+
  labs(x = "B/Bmsy", y= "F/Fsmy") +
  theme_minimal()+
  theme(legend.title=element_blank())+
  ylim(0, 2.5)+
  xlim(0, 2.5)+
  geom_hline(aes(yintercept=1))+
  geom_vline(aes(xintercept=1))+
  ggtitle("KOBE Plot: RAM only Fisheries")

```


##KOBE Plots with only most recent year of fisheries
###All Data Sources
No data: ITQ = FALSE
```{r}

fisheries_KOBE <- fisheries_recent %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0")) 

fisheries_KOBE$rightsbased[fisheries_KOBE$rightsbased == "0"]<- "No ITQ"
fisheries_KOBE$rightsbased[fisheries_KOBE$rightsbased == "1"]<- "ITQ"

#graphing 
F_B_graph <- ggplot(data = fisheries_KOBE, aes( x=BvBmsy, y=FvFmsy, colour= rightsbased, size = Catch ))+
  geom_point()+
  labs(x = "B/Bmsy", y= "F/Fsmy") +
  theme_minimal()+
  theme(legend.title=element_blank())+
  ylim(0, 2.5)+
  xlim(0, 2.5)+
  geom_hline(aes(yintercept=1))+
  geom_vline(aes(xintercept=1))+
  ggtitle("KOBE Plot:  All Fisheries")

```

LOOK AT THIS TOMORROW. ITQ AND NO ITQ CATCH PROJECTIONS SHOULD BE THE SAME, USING SAME DATA, BUT THEY ARE NOT. WTF?
- solved

##Total Catches in most recent year of ITQ, no ITQ, and Turfs
```{r}

fisheries_recent <- read_csv("data/fisheries_recent.csv")

#assuming that when no data is present for itqs/turf that means there are none
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"
fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"

fisheries_rightsbased <- fisheries_recent %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1"
    ))

turfs <- filter(fisheries_rightsbased, rightsbased == "2")
itq <- filter(fisheries_rightsbased, rightsbased == "1")
no_itq <- filter(fisheries_rightsbased, rightsbased == "0")

sum(turfs$Catch, na.rm = TRUE)
#174065.5

sum(itq$Catch, na.rm = TRUE)
#3874741

sum(no_itq$Catch, na.rm = TRUE)
#66155763

```

turf = 174,065.5 = 0.248% of total catch
itq = 3,874,741 = 5.5% of total catch
no itq = 66,155,763 = 94.23% of total catch
Total = 70,204,569.5

## Total Catch: A more generous estimation of Turf catch
```{r}

fisheries_recent <- read_csv("data/fisheries_recent.csv")

#load in data for turf/itq only projection
turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf)

fisheries_recent_generousturf_1 <- select(fisheries_recent, Country, assess_id_short, Year.x,SciName, Catch, itq, ivq, iq)

#merge the most recent data on each fishery with turf data
fisheries_recent_generousturf <- merge(fisheries_recent_generousturf_1,turf_only, by = c("Country", "SciName") , all.x = "TRUE")

#assuming that when no data is present for itqs/turf that means there are none
fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1"
    ))

#create dfs for turf, itq, and no itq fisheries to calculate the sum of each
#NOTE to rememeber: the data from these fisheries are the most recent numbers we have. they are not all in the same year 
turfs_generous <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "2")
itq_generous <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "1")
no_itq_generous <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "0")

sum(turfs_generous$Catch, na.rm = TRUE)
#1530353

sum(itq_generous$Catch, na.rm = TRUE)
#8374634

sum(no_itq_generous$Catch, na.rm = TRUE)
#69025946

```

Generous Turf Catch Estimates:

turf = 1,530,353 -> 1.93% global catch
itq= 8,374,634 -> 10.6% global catch
no itq =  69,025,946 -> 87.46% global catch

Total: 78,930,933

*note: 5643 actual rows
5707 when manually added added
- this means 64 species were matched with existing species in database
- when separated out all by species it was worse
- separate remaining by genus?

##Logit regressions

new UN GDP data, 2016 only
Scaled GDPs
Rerun Regressions
###itq or turf: probablity of itq = f(ISSCAPP and GDP)

```{r}

fisheries_recent <- read_csv("data/fisheries_recent.csv")

fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf, SpeciesCat) 

fisheries_recent_generousturf_1 <- fisheries_recent %>%
  select(Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq)

fisheries_recent_generousturf <- merge(turf_only, fisheries_recent_generousturf_1, by = c("Country", "SciName"), all = "TRUE")

fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE | iq == FALSE | ivq == FALSE ~ "0"
    ))

gdp_all <- read_excel("data/un_gdp_2016.xls")

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 


merge_gdp_rightsbased <- merge(gdp, fisheries_recent_generousturf_rightsbased, by = c("Country"))

gdp_rightsbased <- filter(merge_gdp_rightsbased, SpeciesCat != "NA" )

gdp_rightsbased$SpeciesCat <- factor(gdp_rightsbased$SpeciesCat)
gdp_rightsbased$rightsbased <- as.numeric(gdp_rightsbased$rightsbased)
                              

itq_glm <- glm(formula = rightsbased ~ gdp_center + SpeciesCat, family = "binomial", data = gdp_rightsbased)
itq_glm

summary(itq_glm)
```

##Larger Categories for ISSCAAP Codes
11,13 = freshwater fish = 1
22-24 = diadromous fishes = 2
31-35, 37 = marine fishes = 3
42-45,47 = crustaceans = 4
52-58 = molluscs = 5
74,76,77 = miscellaneous aquatic animals = 7

```{r}

fisheries_recent <- read_csv("data/fisheries_recent.csv")

fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf, SpeciesCat) 

fisheries_recent_generousturf_1 <- fisheries_recent %>%
  select(Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq)

colnames(fisheries_recent_generousturf_1) <- c("Country", "assess_id_short", "Year", "CommName", "Biomass", "Catch", "BvBmsy", "FvFmsy", "Dbase", "SciName", "IdLevel", "SpeciesCat", "Profits", "MSY", "Price", "g", "k", "c", "phi", "itq", "ivq", "iq")

fisheries_recent_generousturf <- merge(turf_only, fisheries_recent_generousturf_1, by = c("Country", "SciName", "SpeciesCat"), all = "TRUE")

fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_regression_1 <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE | iq == FALSE | ivq == FALSE ~ "0"
    )) %>%
  mutate(MainCat = case_when(
    SpeciesCat == 11 | SpeciesCat == 13 ~ "1",
    SpeciesCat == 22 | SpeciesCat == 23 | SpeciesCat == 24 ~ "2",
    SpeciesCat == 31 | SpeciesCat == 32 | SpeciesCat == 33 | SpeciesCat == 34 | SpeciesCat     == 35 | SpeciesCat == 37 ~ "3",
    SpeciesCat == 42 | SpeciesCat == 43 | SpeciesCat == 44 | SpeciesCat == 45 | SpeciesCat      == 47 ~ "4",
    SpeciesCat == 52 | SpeciesCat == 53 | SpeciesCat ==54 |  SpeciesCat == 55 | SpeciesCat     == 56 | SpeciesCat == 57 | SpeciesCat == 58 ~ "5",
    SpeciesCat == 74 | SpeciesCat == 76 | SpeciesCat == 77 ~ "7"
  )) %>%
  select(Country, SciName, MainCat, rightsbased) %>%
  filter(MainCat != "NA")


gdp_all <- read_excel("data/un_gdp_2016.xls")

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 


merge_gdp_mc_rb <- merge(gdp, fisheries_recent_regression_1, by = c("Country"))

gdp_mc_rb <- filter(merge_gdp_mc_rb, MainCat != "NA" )

gdp_mc_rb$MainCat <- factor(gdp_mc_rb$MainCat)
gdp_mc_rb$rightsbased <- as.numeric(gdp_mc_rb$rightsbased)
                              

itq_glm_mc <- glm(formula = rightsbased ~ gdp_center + MainCat, family = "binomial", data = gdp_mc_rb)

itq_glm_mc

summary(itq_glm_mc)

```


Run Turf versus ITQ probably: prob(ITQ). Turf = 1 and ITQ = 0 with the data set that was the turf/itq only one
```{r}
fisheries_recent <- read_csv("data/fisheries_recent.csv")

fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf, SpeciesCat) 

fisheries_recent_generousturf_1 <- fisheries_recent %>%
  select(Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq)

fisheries_recent_generousturf <- merge(turf_only, fisheries_recent_generousturf_1, by = c("Country", "SciName"), all = "TRUE")

fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "1",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "0"
    ))

gdp_all <- read_excel("data/un_gdp_2016.xls")

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 

join_gdp_rightsbased <- merge(gdp, fisheries_recent_generousturf_rightsbased, by = c("Country"))

gdp_rightsbased <- filter(join_gdp_rightsbased, SpeciesCat != "NA" )

gdp_rightsbased$SpeciesCat <- factor(gdp_rightsbased$SpeciesCat)
gdp_rightsbased$rightsbased <- as.numeric(gdp_rightsbased$rightsbased)
                              

itq_turf_glm <- glm(formula = rightsbased ~ gdp_center + SpeciesCat, family = "binomial", data = gdp_rightsbased)
itq_glm

summary(itq_turf_glm)

```

###Larger ISSCAAP Cat
```{r}
fisheries_recent <- read_csv("data/fisheries_recent.csv")

fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf, SpeciesCat) 

fisheries_recent_generousturf_1 <- fisheries_recent %>%
  select(Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq)

fisheries_recent_generousturf <- merge(turf_only, fisheries_recent_generousturf_1, by = c("Country", "SciName"), all = "TRUE")

fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_turf_i_mc <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "1",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "0"
    ))%>%
  mutate(MainCat = case_when(
    SpeciesCat == 11 | SpeciesCat == 13 ~ "1",
    SpeciesCat == 22 | SpeciesCat == 23 | SpeciesCat == 24 ~ "2",
    SpeciesCat == 31 | SpeciesCat == 32 | SpeciesCat == 33 | SpeciesCat == 34 | SpeciesCat     == 35 | SpeciesCat == 37 ~ "3",
    SpeciesCat == 42 | SpeciesCat == 43 | SpeciesCat == 44 | SpeciesCat == 45 | SpeciesCat      == 47 ~ "4",
    SpeciesCat == 52 | SpeciesCat == 53 | SpeciesCat ==54 |  SpeciesCat == 55 | SpeciesCat     == 56 | SpeciesCat == 57 | SpeciesCat == 58 ~ "5",
    SpeciesCat == 74 | SpeciesCat == 76 | SpeciesCat == 77 ~ "7"
  )) %>%
  select(Country, SciName, MainCat, rightsbased) %>%
  filter(MainCat != "NA")


gdp_all <- read_excel("data/un_gdp_2016.xls")

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 

join_gdp_turf_i_mc <- merge(gdp, fisheries_recent_turf_i_mc, by = c("Country"))

gdp_turf_i_mc <- filter(join_gdp_turf_i_mc, MainCat != "NA" )

gdp_turf_i_mc$MainCat <- factor(gdp_turf_i_mc$MainCat)
gdp_turf_i_mc$rightsbased <- as.numeric(gdp_turf_i_mc$rightsbased)
                              

turf_itq_mc_glm <- glm(formula = rightsbased ~ gdp_center + MainCat, family = "binomial", data = gdp_turf_i_mc)
turf_itq_mc_glm

summary(turf_itq_mc_glm)
```


##Diagnostics

```{r}

##run above chunk to get gdp_rightsbased df not the old csv file that is now archived in data folder

diagnostics <- gdp_rightsbased %>%
  mutate(management = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    turf == TRUE ~ "2",
    itq == FALSE | iq == FALSE | ivq == FALSE | turf == FALSE ~ "0"
    )) %>%
  select(Country, gdp_center, SpeciesCat, management)

#diagnostics wont run with non-numeric?
diagnostics$SpeciesCat <- as.numeric(diagnostics$SpeciesCat)
diagnostics$management <- as.numeric(diagnostics$management)

#2= gdp; 4= turf; 5 = SpeciesCat; 23 = itq; 24= ivq; 25 = iq; 26= binary rights based
pairs(diagnostics[2:4]) 

#pearson's r correlations
cor(diagnostics[2:4]) 

#run chi square?


```

####Bar Chart: Coefficient Species Category

###MPA New Costello Data
These MPAs are at least partitally no-take but some of the percentages are very low

```{r}

mpa_costello_data <- read_excel("data/mpa_costello_data.xlsx")

##Choose only MPAs that have some no take
mpa_no_take <- mpa_costello_data %>%
  filter(no_take == "1")

mpa_no_take_10 <- top_n(mpa_no_take, 10, mpa_area)
mpa_no_take_10

##all countries
mpa_no_take_10$Country <- factor(mpa_no_take_10$Country, levels = mpa_no_take_10$Country[order(mpa_no_take_10$mpa_area)])

ggplot(mpa_no_take_10, aes(x = Country, y = mpa_area)) +
  geom_bar(stat = "identity")+
  ggtitle("Top 10 Countries with No Take MPAs")+
  coord_flip()+
  theme_bw()+
  ylab("Area km2")

```

These are the countries with the highest area of no-take
```{r}
mpa_costello_data <- read_excel("data/mpa_costello_data.xlsx")

##Choose only MPAs that have some no take
mpa_no_take <- mpa_costello_data %>%
  filter(no_take == "1")

mpa_no_take_area_10 <- top_n(mpa_no_take, 10, no_take_area)
mpa_no_take_area_10

##all countries
mpa_no_take_area_10$Country <- factor(mpa_no_take_area_10$Country, levels = mpa_no_take_area_10$Country[order(mpa_no_take_area_10$no_take_area)])

ggplot(mpa_no_take_area_10, aes(x = Country, y = no_take_area)) +
  geom_bar(stat = "identity")+
  ggtitle("Top 10 Countries with Largest No Take Areas")+
  coord_flip()+
  theme_bw()+
  ylab("Area km2")

```

```{r}
#load in DiscoverTURFs data
d_turfs <- read_excel("data/DiscoverTURFs_simple.xlsx")
edf_turf <- read_excel("data/EDF_TURF_data.xlsx")
edf_turf_simple <- select(edf_turf, "country", "start_date", "SciName", "turf")

colnames(edf_turf_simple) <- c("Country", "programstart", "SciName", "turf")

turfs_edf_dt <- join(edf_turf_simple, d_turfs, by = c("Country", "SciName"), type = "full")

#write.csv(turfs_edf_dt, file = "turfs_edf_dt.csv")

```

#######################
#######################
1/2/2019

Chris:
1) The Kobe plot has a strange upward sloping line and a strange downward sloping line.  I wonder if you might be using the wrong FvFmsy or BvBmsy fields from RAM?  Dan - could you look at her code?

2) The % of catch from ITQ (which you get as 5%) seems very low.  I think it should be around 25%.  Please re-check it.  Peruvian anchoveta alone should be around 9%.

Dan:
Almost looks like its plotting a control rule? Ohhhh you know what it might be? For the projections in te upside For the ITQ stocks it applies the MEY control rule to EQ, which would result in shutting down fishing for the low b values. There is some nuance in making sure that youre getting status estimates not projections. Looked at the code, Juliette where is the .csv with the recent status estimates coming from? I dont see any code to generate it in the repo. Ill take a closer look tonight or tomorrow. But Id bet that youre pulling projections with a control rule applies instead of assessments



##Total Catch: Most recent year for each fishery 
```{r}

fisheries_recent <- read_csv("data/fisheries_recent.csv")

#assuming that when no data is present for itqs/turf that means there are none
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"
fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"

fisheries_turf_itqs_1 <-unique( fisheries_recent[ , 1:23 ] )

fisheries_turf_itqs <- fisheries_turf_itqs_1 %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0"
    )) 


turfs_catch <- filter(fisheries_turf_itqs, rightsbased == "2")
itq_catch <- filter(fisheries_turf_itqs, rightsbased == "1")
no_itq_catch <- filter(fisheries_turf_itqs, rightsbased == "0")

sum(turfs_catch$Catch, na.rm = TRUE)

sum(itq_catch$Catch, na.rm = TRUE)

sum(no_itq_catch$Catch, na.rm = TRUE)

```

turf = 174,065.5 = 0.248% of total catch
itq = 3,874,741 = 5.5% of total catch
no itq = 66,155,763 = 94.23% of total catch
Total = 70,204,569.5

## Total Catch: A more generous estimation of Turf catch

```{r message =FALSE}

#load data with info only on most recent year for each fishery (includes upside, updated with RAMs, corbette itq/turf data)
fisheries_recent <- read_csv("data/fisheries_recent.csv")

#turf data from edf and discover turfs
turfs_edf_dt <- read_csv("data/turfs_edf_dt.csv")
```

```{r}

fisheries_recent_generousturf_1 <- select(fisheries_recent, Country, assess_id_short, Year.x,SciName, Catch, itq, ivq, iq)

#merge the most recent data on each fishery with turf data
fisheries_recent_generousturf <- merge(fisheries_recent_generousturf_1, turfs_edf_dt, by = c("Country", "SciName") , all.x = "TRUE")

#assuming that when no data is present for itqs/turf that means there are none
fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1"
    ))

#create dfs for turf, itq, and no itq fisheries to calculate the sum of each
#NOTE to rememeber: the data from these fisheries are the most recent numbers we have. they are not all in the same year 

turfs_generous <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "2")
itq_generous <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "1")
no_itq_generous <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "0")

sum(turfs_generous$Catch, na.rm = TRUE)

sum(itq_generous$Catch, na.rm = TRUE)

sum(no_itq_generous$Catch, na.rm = TRUE)

```


Generous Turf Catch Estimates:

turf = 1,643,571 -> 2.3% global catch
itq= 3,874,741 -> 5.5% global catch
no itq =  64,815,841 -> 92.1% global catch

Total: 70,334,153


#####
1/7/2019
Catch estimate with average over last 5 years and over last 10 years


##Percent Catch ITQ over last 5 Years

```{r}

fisheries_recent_5years <- read_csv("data/fisheries_recent_5years.csv")

#assuming that when no data is present for itqs/turf that means there are none
fisheries_recent_5years$turf[is.na(fisheries_recent_5years$turf)] <- "FALSE"
fisheries_recent_5years$itq[is.na(fisheries_recent_5years$itq)] <- "FALSE"
fisheries_recent_5years$ivq[is.na(fisheries_recent_5years$ivq)] <- "FALSE"
fisheries_recent_5years$iq[is.na(fisheries_recent_5years$iq)] <- "FALSE"


###creating new column for management; also merging country and the name of species in order to have a way of IDing the fishery to merge with averages in next code peiece
fisheries_turf_itqs_5years_1 <- fisheries_recent_5years %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0"
    ))

##get average catch over last 5 years for each fishery
mean_5years <- aggregate(fisheries_turf_itqs_5years_1[, 7], list(fisheries_turf_itqs_5years_1$assess_id_short), mean)

colnames(mean_5years) <- c("assess_id_short", "FiveYearCatchAvg")

fisheries_turf_itqs_5years <-  merge(fisheries_turf_itqs_5years_1, mean_5years, by.x = "assess_id_short")

turfs_catch <- filter(fisheries_turf_itqs_5years, rightsbased == "2")
itq_catch <- filter(fisheries_turf_itqs_5years, rightsbased == "1")
no_itq_catch <- filter(fisheries_turf_itqs_5years, rightsbased == "0")

sum(turfs_catch$FiveYearCatchAvg, na.rm = TRUE)

sum(itq_catch$FiveYearCatchAvg, na.rm = TRUE)

sum(no_itq_catch$FiveYearCatchAvg, na.rm = TRUE)


```
Turf: 234,000
ITQ: 4,093,520 = 5.1%


##Percent Catch ITQ over last 10 Years
** different method
```{r}

fisheries_recent_10years <- read_csv("data/fisheries_recent_10years.csv")

#assuming that when no data is present for itqs/turf that means there are none
fisheries_recent_10years$turf[is.na(fisheries_recent_10years$turf)] <- "FALSE"
fisheries_recent_10years$itq[is.na(fisheries_recent_10years$itq)] <- "FALSE"
fisheries_recent_10years$ivq[is.na(fisheries_recent_10years$ivq)] <- "FALSE"
fisheries_recent_10years$iq[is.na(fisheries_recent_10years$iq)] <- "FALSE"


###creating new column for management; also merging country and the name of species in order to have a way of IDing the fishery to merge with averages in next code peiece
fisheries_turf_itqs_10years_1 <- fisheries_recent_10years %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0"
    )) 

##get average catch over last 5 years for each fishery
mean_10years <- aggregate(fisheries_turf_itqs_10years_1[, 7], list(fisheries_turf_itqs_10years_1$assess_id_short), mean)
colnames(mean_10years) <- c("assess_id_short", "TenYearCatchAvg")

fisheries_turf_itqs_10years_2 <- select(fisheries_turf_itqs_10years_1, "assess_id_short", "rightsbased", "CommName")

fisheries_turf_itqs_10years <-  merge(fisheries_turf_itqs_10years_2, mean_10years, by.x = "assess_id_short")

turfs_catch <- filter(fisheries_turf_itqs_10years, rightsbased == "2")
itq_catch <- filter(fisheries_turf_itqs_10years, rightsbased == "1")
no_itq_catch <- filter(fisheries_turf_itqs_10years, rightsbased == "0")

sum(turfs_catch$TenYearCatchAvg, na.rm = TRUE)

sum(itq_catch$TenYearCatchAvg, na.rm = TRUE)

sum(no_itq_catch$TenYearCatchAvg, na.rm = TRUE)


```
Turf: 234,000
ITQ: 4,115,210 = 5.1%








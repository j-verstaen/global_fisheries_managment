---
title: "figures and calculations for global fisheries management"
output:
  pdf_document: default
  html_notebook: default
---

```{r load}
library(tidyverse)
library(readxl)
library(tidyxl)
library(here)

fisheries_recent <- read_csv(here("processed_data","fisheries_recent.csv"))%>% 
  janitor::clean_names()

```



# figures


## figure 1 Kobe plot with assessed vs. unassessed (color), size/alpha by size. Medians by size.

A traditional Kobe plot of fishery status. Horizontal axis is $B/Bmsy$ and vertical axis is $F/Fmsy$. Each point is a single fishery. Size and shading indicates $MSY$ of the fishery and color indicates whether the fishery has a stock assessment. Medians for stock assessed, and unassesed fisheries are presented as triangles.


```{r fig-1-kobe}

fig_1 = mtcars %>% 
  ggplot(aes(mpg)) + 
  geom_histogram()


ggsave(here("figures","figure-1.pdf"), fig_1)


```


## figure 2 map of RBFM map of RBFM around the planet Color the country if it has ITQ

Global map of countries that manage at least some of their fish catch with ITQs.

```{r}

```


## figure 3  status by RBFM - Kobe, color is RBFM, size is size. Medians RBFM and RBFM-.

A traditional Kobe plot of fishery status for stocks present in the RAM legacy stock assessment database. Horizontal axis is $B/Bmsy$ and vertical axis is $F/Fmsy$. Each point is a single fishery. Size and shading indicates $MSY$ of the fishery and color indicates whether the fishery is managed with RBFM. Medians for RBFM and non-RBFM fisheries are shown as triangles.

## figure 4 bioeconomic figure to show in principle why you get increase in value from RBFM


Simple bioeconomic model represntation illustrating the mechanisms by which RBFM can increase fishery profit, food provision, and biomass of fish


## figure 5 is global fishing watch, JC

## figure 6 figure of bionomic equilibrium and shift in cost downward 


# calculations

## line 22 

"and is roughly equivalent to total land and sea production of aquaculture XX"

```{r}

```

## line 53

Famous fisheries such as Alaskan halibut and king crab both experienced derby periods, during which the season could be as short as 24 hours, producing XX in estimated dollars lost

```{r}

```

## line 65

Using data from (Costello et al., 2016), we can identify which of the fisheries identified by the FAO are currently being managed using ITQs, and from there estimate that xx\% of annual global marine capture comes from fisheries currently managed under ITQs

```{r}

```

## line 70 

Based on this calculation, we find that up to xx\% of global catch comes from TURFs and up to XX \% comes from cooperatives. In total, based on best available data to date,  we estimate that somewhere between XXX\% and XXX\% of global wild fish catch comes from all forms of RBFM combined. The What kinds of fisheries make up this RBFM catch? RBFM catches come from XX\% of the countries reporting  fish catches in 2016xx.

```{r}

```

## line 92

What factors drive the adoption of various forms of RBFM? Anecdotal evidence suggests that large, industrial fisheries, often for mobile species are most likely to adopt some form of ITQ, while small-scale artisinal fisheries, often for benthic species, are most likely to adopt a TURF. To test this expectation, we built a dataset of XXX ITQ fisheries and XXX TURF fisheries, and matched them to the fishery classification in \cite{Upside}. This provided us with a dataset of XXX fisheries with the country, species or genus name, and some other ecological and economic characteristics. Conditional on adopting some form of RBFM, our goal was to estimate the likelihood of adopting an ITQ versus a TURF. To do so, we ran a logistic regression with ITQ on the left ha

## line 94 regression
 put equation and all regression analysis in this section

$$Pr(ITQ_i) = f(Genus_i, GDP_i, ...) + \epsilon_i$$

GDP data source: UN website
Regular ISSCAAP Categories
```{r}

projection_data <- readRDS(here("data","projection_data.rds")) %>% 
  filter(Scenario == "Historic")

gdp_all <- read_excel(here("data","un_gdp_2016.xls"))

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 

join <- left_join(projection_data, gdp, by = "Country")

join$SpeciesCat <- factor(join$SpeciesCat)
                              
itq_fit <- glm(formula = CatchShare ~ gdp_center + SpeciesCatName, family = "binomial", data = join)

summary(itq_fit)

check <- broom::augment(itq_fit)
```

Broader ISSCAAP Categories
22-24 = diadromous fishes = 2
31-35, 37 = marine fishes = 3
42-45,47 = crustaceans = 4
52-58 = molluscs = 5
74,76,77 = miscellaneous aquatic animals = 7

```{r}

#upside projection data
projection_data <- readRDS(here("data","projection_data.rds")) %>% 
  filter(Scenario == "Historic")

#GDP data
gdp_all <- read_excel(here("data","un_gdp_2016.xls"))

#EDF TURF data
edf_turf <- read_excel("data/EDF_TURF_data.xlsx") %>%
  select("Country", "SciName","CatchShare") %>%
  filter(SciName != "NA")

#DiscoverTURFs data
d_turfs <- read_excel("data/DiscoverTURFs_simple.xlsx") %>%
  select("Country", "SciName", "CatchShare") %>%
  filter(SciName != "NA")

#ISSCAAP Codes
isscaap <- read_csv("data/meta_isscaap_codes.csv")
#######################################################

#get turf data to have species category codes

all_turfs <- plyr::join(d_turfs, edf_turf, by= c("Country", "SciName", "CatchShare"), type = "full" ) %>%
  distinct()

turfs <- plyr::join(all_turfs, isscaap, by= c("SciName")) %>%
  filter(SciName !="NA")%>%
  filter(SpeciesCat != "NA")

#add the turf data to upside
projection_turfs <- merge(projection_data, turfs, by = c("Country", "SciName", "SpeciesCat", "CatchShare"), all = T)

projection_turfs_mutate <- projection_turfs  %>%
  mutate(MainCat = case_when(
    SpeciesCat == 22 | SpeciesCat == 23 | SpeciesCat == 24 ~ "2",
    SpeciesCat == 31 | SpeciesCat == 32 | SpeciesCat == 33 | SpeciesCat == 34 | SpeciesCat     == 35 | SpeciesCat == 37 ~ "3",
    SpeciesCat == 42 | SpeciesCat == 43 | SpeciesCat == 44 | SpeciesCat == 45 | SpeciesCat      == 47 ~ "4",
    SpeciesCat == 52 | SpeciesCat == 53 | SpeciesCat ==54 |  SpeciesCat == 55 | SpeciesCat     == 56 | SpeciesCat == 57 | SpeciesCat == 58 ~ "5",
    SpeciesCat == 74 | SpeciesCat == 76 | SpeciesCat == 77 ~ "7"
  )) 

gdp_all <- read_excel(here("data","un_gdp_2016.xls"))

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 

#question here, will the filter remove out when year is NA? the turf data doesn't have this resolution; edf does have start date though
join_mutate <- left_join(projection_turfs_mutate, gdp, by = "Country") %>% 
  filter(Year == max(Year))

join_mutate$MainCat <- factor(join_mutate$MainCat)

downjoin <- caret::downSample(x = select(join_mutate,-CatchShare),
                              y = factor(join_mutate$CatchShare),
                              yname = "CatchShare")
downjoin %>% 
  ggplot(aes(log(MSY),fill = CatchShare)) + 
  geom_density()

                 
itq_broad_fit <-
  glm(
    formula = CatchShare ~ gdp_center + MainCat + log(MSY),
    family = "binomial",
    data = downjoin
  )

bayes_itq_broad_fit <-
  rstanarm::stan_glmer(
    formula = CatchShare ~ gdp_center + (1|MainCat),
    family = "binomial",
    data = downjoin,
    cores = 4
  )


summary(itq_broad_fit)

aug_itq_broad_fit <- broom::augment(itq_broad_fit) %>% 
  mutate(pred = predict(itq_broad_fit, type = "response"))

orig_itq_broad_fit <- join_mutate %>% 
  mutate(pred = predict(itq_broad_fit, type = "response", newdata = join_mutate))


catchshare_pred_plot <- orig_itq_broad_fit %>% 
  ggplot(aes(pred,CatchShare == 1,fill = CatchShare == 1)) + 
  ggridges::geom_density_ridges(show.legend = FALSE) +
  geom_vline(aes(xintercept = 0.5), linetype = 2, color = "red") +
  labs(y = "Is Catch Share?",
       x = "Probability of Catch Share",
       caption = "Classified as catch share if p>0.5") 

aug_itq_broad_fit %>% 
  ggplot(aes(gdp_center, pred, color = MainCat)) + 
  geom_point()

aug_itq_broad_fit %>% 
  ggplot(aes(MainCat, pred)) + 
  geom_boxplot()



catchshare_pred_plot

g <- pROC::roc(CatchShare ~ pred, data = orig_itq_broad_fit)

pROC::ggroc(g) + 
  geom_abline(aes(intercept = 1, slope =  1), color = "red")

```




## line 107 

to all XX non-rbfm fisheries in the (however many fisheries are not catch shares in projection_data)


```{r}

```

As a percentage of fishery potential (estimated maximum sustainable yield, MSY), the breakdown is XXX\% (ITQ) and XXX\% (TURF). The table below presents the results of this extrapolation for the world's top 20 fishing nations.

```{r}

```


## line 118

Using that approach, authors have estimated a benefit of global RBFM between \$XXX Billion and \$XXX Billion per year. see Costello et al. 2016

## line 120

adopt this bottom up approach, and develop fishery-by-fishery bioeconomic models for 4,7XX fisheries around the world, representing XXX\% of global fish catch. Using that sample, \cite{Upside} estimate an increase in catch of XXX, an increase in biomass of XXX, and an annual economic benefit from RBFM of \$XXX Billion. Scaling this number up by the fraction of catch missing in the database, provides an annual estimate of \$XXX Billion.

## line 122

While the methods differ substantially, estimates of the economic benefit from globally adopting RBFM are all in the vicinity of \$XXX Billion - \$XXX Billion. But achieving these benefits would require substantial re-tooling of the institutions used to govern the oceans and will likely come at a significant cost. Estimating this cost is complicated by the lack of consistent data on the cost of fishery management across fisheries and countries. Recent estimates suggest that annual fishery management costs are in the ballpark of \$XXX to \$XXX per MT of fish catch. Applying this globally provides a cursory estimate of \$XXX Billion for fishery management. But the few studies that have been undertaken also suggest that fishery management costs vary significantly across countries (for example, XXXX). And what we really would like is an estimate of the \textit{change} in fishery management cost associated with adopting RBFM. In a recent paper, \cite{Mangin} provide precisely this estimate. Working fishery-by-fishery, they estimate a global increased cost of \$XXX Billion from adopting RBFM at a global scale. Comparing this number to the potential economic benefits strongly suggests that the benefits of RBFM expansion will outweigh the increased costs; a result echoed by \cite{Sumaila}. The following table summarizes the studies of the benefits and costs of global-scale adoption of RBFM.

https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0204258

## line 143
no-take
As a result of these potential conservation and fishery effects, MPAs have been increasingly proposed as a solution to global fisheries sustainability. For example, the Convention on Biological Diversity's Strategic Plan for Biodiversity  call for 10\% of coastal waters to be protected inside MPAs by 2020. This call has been accompanied by the creation of large MPAs in places such as XX and XX. Table XXX shows the area covered by MPAs in the top-10 MPA countries of the world.  Together, the MPAs in these countries represent the vast majority (XXX\%) of global coverage of MPAs, recognizing that the total global ocean covered by MPAs is still very small (XXX\%). 

```{r}

```



# rbfm

However, while these fisheries make up XX\% of global captures
```{r}

global_summaries <- fisheries_recent %>% 
  group_by(dbase) %>% 
  summarise(total_catch = sum(catch, na.rm = T),
            n = n_distinct(assess_id_short))



```

# mpas


```{r}

mpas <- readxl::read_xlsx(here("data","MPA Analysis. Country Analysis.xlsx"), sheet = "clean_mpa") %>% janitor::clean_names()


```


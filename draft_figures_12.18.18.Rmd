---
title: "draft_figures_12.18.18"
author: "Juliette Verstaen"
date: "12/18/2018"
output: pdf_document
toc: true
toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE }

suppressPackageStartupMessages({
  library(tidyverse)
  library(tidyr)
  library(here)
  library(ggplot2)
  library(dplyr)
  library(readxl)
  library(devtools)
  library(plotly)
  library(base)
  library(rio)
  library(plyr)
})
```


##KOBE Plots with only most recent year of fisheries
###RAM only
No data: ITQ = FALSE

```{r}

#read in data: this is updated projection data (updated using RAMs) and Corbett's ITQ/Turf data applied to each fishery. only data for most recent year for each fishery is represented.

fisheries_recent <- read_csv("data/fisheries_recent.csv")

#assuming that when no data is avaliable on the fishery inregardes to ITQ or Turfs that means there are none
fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

```


```{r}

#only looking at fisheries data that come from RAMS database
# creating new column called "rightsbased" where 1 = ITQ and 0 = No ITQ
fisheries_KOBE_ram <- fisheries_recent %>%
  filter(Dbase == "RAM") %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0")) 

#graphing 
fisheries_KOBE_ram$rightsbased[fisheries_KOBE_ram$rightsbased == "0"]<- "No ITQ"
fisheries_KOBE_ram$rightsbased[fisheries_KOBE_ram$rightsbased == "1"]<- "ITQ"

ggplot(data = fisheries_KOBE_ram, aes( x=BvBmsy, y=FvFmsy, colour= rightsbased, size = Catch ))+
  geom_point()+
  labs(x = "B/Bmsy", y= "F/Fsmy") +
  theme_minimal()+
  theme(legend.title=element_blank())+
  ylim(0, 2.5)+
  xlim(0, 2.5)+
  geom_hline(aes(yintercept=1))+
  geom_vline(aes(xintercept=1))+
  ggtitle("KOBE Plot: RAM only Fisheries")

```


##KOBE Plots with only most recent year of fisheries
###All Data Sources
No data: ITQ = FALSE
```{r}

fisheries_KOBE <- fisheries_recent %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0")) 

fisheries_KOBE$rightsbased[fisheries_KOBE$rightsbased == "0"]<- "No ITQ"
fisheries_KOBE$rightsbased[fisheries_KOBE$rightsbased == "1"]<- "ITQ"

#graphing 
F_B_graph <- ggplot(data = fisheries_KOBE, aes( x=BvBmsy, y=FvFmsy, colour= rightsbased, size = Catch ))+
  geom_point()+
  labs(x = "B/Bmsy", y= "F/Fsmy") +
  theme_minimal()+
  theme(legend.title=element_blank())+
  ylim(0, 2.5)+
  xlim(0, 2.5)+
  geom_hline(aes(yintercept=1))+
  geom_vline(aes(xintercept=1))+
  ggtitle("KOBE Plot:  All Fisheries")

```

LOOK AT THIS TOMORROW. ITQ AND NO ITQ CATCH PROJECTIONS SHOULD BE THE SAME, USING SAME DATA, BUT THEY ARE NOT. WTF?

##Total Catches in most recent year of ITQ, no ITQ, and Turfs
```{r}

fisheries_recent <- read_csv("data/fisheries_recent.csv")

#assuming that when no data is present for itqs/turf that means there are none
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"
fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"

fisheries_rightsbased <- fisheries_recent %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1"
    ))

turfs <- filter(fisheries_rightsbased, rightsbased == "2")
itq <- filter(fisheries_rightsbased, rightsbased == "1")
no_itq <- filter(fisheries_rightsbased, rightsbased == "0")

sum(turfs$Catch, na.rm = TRUE)
#174065.5

sum(itq$Catch, na.rm = TRUE)
#3874741

sum(no_itq$Catch, na.rm = TRUE)
#66155763

```

turf = 174,065.5 = 0.248% of total catch
itq = 3,874,741 = 5.5% of total catch
no itq = 66,155,763 = 94.23% of total catch
Total = 70,204,569.5

## Total Catch: A more generous estimation of Turf catch
```{r}

fisheries_recent <- read_csv("data/fisheries_recent.csv")

#load in data for turf/itq only projection
turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf)

fisheries_recent_generousturf_1 <- select(fisheries_recent, Country, assess_id_short, Year.x,SciName, Catch, itq, ivq, iq)

#merge the most recent data on each fishery with turf data
fisheries_recent_generousturf <- merge(fisheries_recent_generousturf_1,turf_only, by = c("Country", "SciName") , all.x = "TRUE")

#assuming that when no data is present for itqs/turf that means there are none
fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "2",
    itq == FALSE & iq == FALSE & ivq == FALSE ~ "0",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1"
    ))

#create dfs for turf, itq, and no itq fisheries to calculate the sum of each
#NOTE to rememeber: the data from these fisheries are the most recent numbers we have. they are not all in the same year 
turfs_generous <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "2")
itq_generous <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "1")
no_itq_generous <- filter(fisheries_recent_generousturf_rightsbased, rightsbased == "0")

sum(turfs_generous$Catch, na.rm = TRUE)
#1530353

sum(itq_generous$Catch, na.rm = TRUE)
#8374634

sum(no_itq_generous$Catch, na.rm = TRUE)
#69025946

```

Generous Turf Catch Estimates:

turf = 1,530,353 -> 1.93% global catch
itq= 8,374,634 -> 10.6% global catch
no itq =  69,025,946 -> 87.46% global catch

Total: 78,930,933

*note: 5643 actual rows
5707 when manually added added
- this means 64 species were matched with existing species in database
- when separated out all by species it was worse
- separate remaining by genus?

##Logit regressions

new UN GDP data, 2016 only
Scaled GDPs
Rerun Regressions
###itq or turf: probablity of itq = f(ISSCAPP and GDP)

```{r}

fisheries_recent <- read_csv("data/fisheries_recent.csv")

fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf, SpeciesCat) 

fisheries_recent_generousturf_1 <- fisheries_recent %>%
  select(Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq)

fisheries_recent_generousturf <- merge(turf_only, fisheries_recent_generousturf_1, by = c("Country", "SciName"), all = "TRUE")

fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "1",
    itq == FALSE | iq == FALSE | ivq == FALSE ~ "0"
    ))

gdp_all <- read_excel("data/un_gdp_2016.xls")

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 


merge_gdp_rightsbased <- merge(gdp, fisheries_recent_generousturf_rightsbased, by = c("Country"))

gdp_rightsbased <- filter(merge_gdp_rightsbased, SpeciesCat != "NA" )

gdp_rightsbased$SpeciesCat <- factor(gdp_rightsbased$SpeciesCat)
gdp_rightsbased$rightsbased <- as.numeric(gdp_rightsbased$rightsbased)
                              

itq_glm <- glm(formula = rightsbased ~ gdp_center + SpeciesCat, family = "binomial", data = gdp_rightsbased)
itq_glm

summary(itq_glm)
```

Run Turf versus ITQ probably: prob(ITQ). Turf = 1 and ITQ = 0 with the data set that was the turf/itq only one
```{r}
fisheries_recent <- read_csv("data/fisheries_recent.csv")

fisheries_recent$itq[is.na(fisheries_recent$itq)] <- "FALSE"
fisheries_recent$ivq[is.na(fisheries_recent$ivq)] <- "FALSE"
fisheries_recent$iq[is.na(fisheries_recent$iq)] <- "FALSE"
fisheries_recent$turf[is.na(fisheries_recent$turf)] <- "FALSE"

turf_itq_isscaap <- read_csv("data/turf_itq_isscaap.csv")

turf_only <- turf_itq_isscaap %>%
  select(SciName, Country, turf, SpeciesCat) 

fisheries_recent_generousturf_1 <- fisheries_recent %>%
  select(Country, assess_id_short, Year.x, CommName, Biomass, Catch, BvBmsy, FvFmsy, Dbase, SciName, IdLevel, SpeciesCat.x, Profits, MSY, Price, g, k, c, phi, itq, ivq, iq)

fisheries_recent_generousturf <- merge(turf_only, fisheries_recent_generousturf_1, by = c("Country", "SciName"), all = "TRUE")

fisheries_recent_generousturf$turf[is.na(fisheries_recent_generousturf$turf)] <- "FALSE"
fisheries_recent_generousturf$itq[is.na(fisheries_recent_generousturf$itq)] <- "FALSE"
fisheries_recent_generousturf$ivq[is.na(fisheries_recent_generousturf$ivq)] <- "FALSE"
fisheries_recent_generousturf$iq[is.na(fisheries_recent_generousturf$iq)] <- "FALSE"

fisheries_recent_generousturf_rightsbased <- fisheries_recent_generousturf %>%
  mutate(rightsbased = case_when(
    turf == TRUE ~ "1",
    itq == TRUE | iq == TRUE | ivq == TRUE ~ "0"
    ))

gdp_all <- read_excel("data/un_gdp_2016.xls")

gdp <- gdp_all %>%
  select(Country, gdp_center) %>%
  filter( gdp_center != "NA") 


join_gdp_rightsbased <- merge(gdp, fisheries_recent_generousturf_rightsbased, by = c("Country"))

gdp_rightsbased <- filter(join_gdp_rightsbased, SpeciesCat != "NA" )

gdp_rightsbased$SpeciesCat <- factor(gdp_rightsbased$SpeciesCat)
gdp_rightsbased$rightsbased <- as.numeric(gdp_rightsbased$rightsbased)
                              

itq_turf_glm <- glm(formula = rightsbased ~ gdp_center + SpeciesCat, family = "binomial", data = gdp_rightsbased)
itq_glm

summary(itq_turf_glm)

```


####Bar Chart: Coefficient Species Category
